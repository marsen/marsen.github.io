<!DOCTYPE html>
<html>
<head>
  
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NTDGNJZ');</script>
<!-- End Google Tag Manager -->

  
<!-- Google Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RF47NNRE5G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RF47NNRE5G');
</script>
<!-- End Google Analytics -->

  
<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1885096025224905"
     crossorigin="anonymous"></script>
<!-- End Google AdSense -->



  <meta charset="utf-8">
  
  <title>Marsen&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Marsen&#39;s Blog">
<meta property="og:url" content="https://blog.marsen.me/page/16/index.html">
<meta property="og:site_name" content="Marsen&#39;s Blog">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Marsen L.">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Marsen&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
      
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">
  
  
<link rel="stylesheet" href="/css/style.css">

  <meta property ="og:image" content="https://avatars1.githubusercontent.com/u/4269720?s=460&v=4" /> 
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="blog-banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Marsen&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle"></a>
          <div>
          <span style="width: 20px; height: 10px; background: linear-gradient(to bottom, #005BBB 50%, #FFD700 50%); text-align: center; color: white; font-size: 6px; font-weight: bold; line-height: 100px;">
            #StandWithUkraine
          </span>
          </div>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜尋"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.marsen.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2020/github_action_with_stryker_mutator" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/06/2020/github_action_with_stryker_mutator/" class="article-date">
  <time datetime="2020-05-06T01:03:30.000Z" itemprop="datePublished">2020-05-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/06/2020/github_action_with_stryker_mutator/"> [實作筆記] Github 結合 Stryker 作變異測試</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>前年初次接觸<a href="https://blog.marsen.me/2018/03/20/2018/mutation_testing/">變異測試</a>，去年在看<a href="https://blog.marsen.me/2019/03/01/2019/book/refactoring/refactoring_Ch1/">重構</a>時偷換了概念，<br>將兩者結合了。</p>
<p>這次我想更進一步，將 CI Server 與之結合。</p>
<h2 id="Stryker-Net"><a href="#Stryker-Net" class="headerlink" title="Stryker.Net"></a>Stryker.Net</h2><p>根據 <a target="_blank" rel="noopener" href="https://github.com/stryker-mutator/stryker-handbook/blob/master/dashboard.md">Stryker Handbook</a>，<br>Stryker 主要有三個專案，</p>
<ul>
<li>Stryker (Javascript &amp; TypeScript)</li>
<li>Stryker4s (Scala)</li>
<li>Stryker.NET (.NET)</li>
</ul>
<p>我會使用我的練習用<a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/">專案</a>作為目標，<br>所以很理所當然的我會選擇 <code>Stryker.NET</code>，那我們就開始吧。</p>
<h2 id="開始"><a href="#開始" class="headerlink" title="開始"></a>開始</h2><h3 id="安裝-Stryker"><a href="#安裝-Stryker" class="headerlink" title="安裝 Stryker"></a>安裝 Stryker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet tool install -g dotnet-stryker</span><br></pre></td></tr></table></figure>

<h3 id="執行-Stryker"><a href="#執行-Stryker" class="headerlink" title="執行 Stryker"></a>執行 Stryker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet stryker -tp &quot;[&#x27;./test/Marsen.NetCore.Dojo.Tests/Marsen.NetCore.Dojo.Tests.csproj&#x27;,&#x27;./test/Marsen.NetCore.Dojo.Integration.Tests/Marsen.NetCore.Dojo.Integration.Tests.csproj&#x27;]&quot; -p=&quot;Marsen.NetCore.Dojo.csproj&quot; -dk=$STRYKER_DASHBOARD_API_KEY</span><br></pre></td></tr></table></figure>

<p>注意幾個 cli 參數，<br><code>-tp</code> 明確指定測試的專案有哪些，可以用中括號<code>[]</code>傳入多個測試專案名稱，使用<code>,</code>作為分隔符<br><code>-p</code> 專案名稱<br><code>-dk</code> dashboard-api-key 這組 key 是用來與 <code>https://dashboard.stryker-mutator.io/</code> 互動的，<br>最主的功能是將報告上傳。<br>$STRYKER_DASHBOARD_API_KEY 是 <a target="_blank" rel="noopener" href="https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets">Github 的 Secrets</a></p>
<p>你可以執行 <code>dotnet stryker -h</code> 查看更多原始說明</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-tp|--test-projects Specify what test projects should run on the project under test.</span><br><span class="line">-p|--project-file &lt;projectFileName&gt; Used for matching the project references when finding the project to</span><br><span class="line">                                              mutate. Example: &quot;ExampleProject.csproj&quot;</span><br><span class="line">-dk|--dashboard-api-key &lt;api-key&gt; Api key for dashboard reporter. You can get your key here: https://dashboard.stryker-mutator.io</span><br></pre></td></tr></table></figure>

<h3 id="專案設定"><a href="#專案設定" class="headerlink" title="專案設定"></a>專案設定</h3><p>新增一個 <code>stryker-config.json</code><br>對我來說，最重要的是要記得設定 <code>stryker-config &gt; reporters &gt; dashboard</code> 這筆資料。<br><a target="_blank" rel="noopener" href="https://github.com/stryker-mutator/stryker-net/blob/master/docs/Configuration.md">詳細的說明的可以參考這篇</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;stryker-config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dashboard-project&quot;</span><span class="punctuation">:</span> <span class="string">&quot;github.com/marsen/Marsen.NetCore.Dojo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dashboard-version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;master&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reporters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;json&quot;</span><span class="punctuation">,</span> <span class="string">&quot;dashboard&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="在-Github-上工作"><a href="#在-Github-上工作" class="headerlink" title="在 Github 上工作"></a>在 Github 上工作</h3><p>首先你必須在 <a target="_blank" rel="noopener" href="https://dashboard.stryker-mutator.io/">Dashboard</a>中 Enable Repository</p>
<p><img src="/images/2020/5/github_action_with_stryker_mutator_01.jpg" alt="Enable Repository"></p>
<p>然後產生一組 Key</p>
<p><img src="/images/2020/5/github_action_with_stryker_mutator_02.jpg" alt="產生一組 Key"></p>
<p>接下來到 Github ， 我們將這組 Key 設定到 Secrets 之中</p>
<p><img src="/images/2020/5/github_action_with_stryker_mutator_03.jpg" alt="將 Key 設定至 Github"></p>
<p>再到 Github Actions 中，把 workflow 指令設定完成，</p>
<p><img src="/images/2020/5/github_action_with_stryker_mutator_04.jpg" alt="Github Actions"></p>
<p>觸發 CI 完成後，就可以在 <a target="_blank" rel="noopener" href="https://dashboard.stryker-mutator.io/reports/github.com/marsen/Marsen.NetCore.Dojo/master">Dashboard</a> 上看到報表啦。</p>
<p><img src="/images/2020/5/github_action_with_stryker_mutator_05.jpg" alt="結果呈現"></p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a href="https://blog.marsen.me/2019/03/01/2019/book/refactoring/refactoring_Ch1/">https://blog.marsen.me/2019/03/01/2019/book/refactoring/refactoring_Ch1/</a></li>
<li><a href="https://blog.marsen.me/2018/03/20/2018/mutation_testing/">https://blog.marsen.me/2018/03/20/2018/mutation_testing/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/stryker-mutator/stryker-handbook/blob/master/dashboard.md">https://github.com/stryker-mutator/stryker-handbook/blob/master/dashboard.md</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/stryker-mutator/stryker-net/blob/master/docs/Reporters.md#dashboard-reporter">https://github.com/stryker-mutator/stryker-net/blob/master/docs/Reporters.md#dashboard-reporter</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/05/06/2020/github_action_with_stryker_mutator/" data-id="clzqmjgg1005y2sp01fygc3qt" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/05/06/2020/github_action_with_stryker_mutator/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CI-CD/" rel="tag">CI&#x2F;CD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2020/sonarqube_run_with_github_action_coverage" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/30/2020/sonarqube_run_with_github_action_coverage/" class="article-date">
  <time datetime="2020-04-30T07:30:43.000Z" itemprop="datePublished">2020-04-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/30/2020/sonarqube_run_with_github_action_coverage/"> [實作筆記] Github 結合 SonarCloud 作代碼質量檢查 - 測試覆蓋率篇</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>承<a href="https://blog.marsen.me/2020/04/27/2020/sonarqube_run_with_github_action/">上篇</a>,<br>我已經將 SonarCloud 的代碼檢查與 Github Action 結合在一起了。<br>透過專案首頁的 Dashboard 與專案的 Budget 我可以知道目前專案的一些狀況，<br>壞味道、技術債等 …</p>
<h3 id="題外話，測試分類"><a href="#題外話，測試分類" class="headerlink" title="題外話，測試分類"></a>題外話，測試分類</h3><p>在我的專案中有兩種測試，單元測試與整合測試。<br>我的分類方法，單一類別的 public 方法就用單元測試包覆。<br>不同的類別之如果有組合的交互行為，就用整合測試包覆。</p>
<p>舉個簡單的例子，以購物流程來說，我有的類別如下 :</p>
<ul>
<li>Cart(購物車)<ul>
<li>Add (加入商品)</li>
<li>Substract (移除商品)</li>
<li>CheckOut (結帳)</li>
</ul>
</li>
<li>Order (訂單)<ul>
<li>Caculate (計算結帳金額)</li>
</ul>
</li>
</ul>
<p>另外有兩種類別如下，</p>
<ul>
<li>ECoupon<ul>
<li>Caculate</li>
</ul>
</li>
<li>Promotion<ul>
<li>Caculate</li>
</ul>
</li>
</ul>
<p>上面的所有方法我都會加上單元測試作保護，<br>但是 Order 在呼叫 Caculate 的時候，<br>會以不同的順序組合 ECoupon.Caculate 與 Promotion.Caculate，<br>這個時候就有可能會產生不同的結果。</p>
<h2 id="執行測試"><a href="#執行測試" class="headerlink" title="執行測試"></a>執行測試</h2><p>同上一篇，整體的流程我們只要在 Build 完後加上測試即可。</p>
<ol>
<li>Begin</li>
<li>MSBuild</li>
<li><strong>Test</strong></li>
<li>End</li>
</ol>
<p>開發環境執行測試</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet test ./test/Marsen.NetCore.Dojo.Tests/Marsen.NetCore.Dojo.Tests.csproj</span><br></pre></td></tr></table></figure>

<p>產生測試報告</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet test ./test/Marsen.NetCore.Dojo.Tests/Marsen.NetCore.Dojo.Tests.csproj --logger:trx;LogFileName=result.trx</span><br></pre></td></tr></table></figure>

<p>測試報告會產生一份 <code>result.trx</code> 檔，在測試專案目錄底下的 <code>TestResults</code> 資料夾裡。<br>如果要在 SonarCloud 上使用請設定 sonar.cs.vstest.reportsPaths (VSTest 適用)，更多資訊請<a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/analysis/coverage/">參考</a>。</p>
<p><img src="/images/2020/4/sonarqube_run_with_github_action_04.jpg" alt="result.trx"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dotnet sonarscanner begin /k:&quot;Marsen.NetCore.Dojo&quot; /o:&quot;marsen-github&quot; /d:&quot;sonar.host.url=https://sonarcloud.io&quot; /d:&quot;sonar.login=&quot;$SONAR_LOGIN</span><br><span class="line">dotnet build &quot;.\Marsen.NetCore.Dojo.Integration.Test.sln&quot;</span><br><span class="line">dotnet test ./test/Marsen.NetCore.Dojo.Tests/Marsen.NetCore.Dojo.Tests.csproj --logger:trx;LogFileName=result.trx</span><br><span class="line">dotnet sonarscanner end /d:&quot;sonar.login=&quot;$SONAR_LOGIN</span><br></pre></td></tr></table></figure>

<h2 id="覆蓋率"><a href="#覆蓋率" class="headerlink" title="覆蓋率"></a>覆蓋率</h2><ol>
<li>Begin</li>
<li>MSBuild</li>
<li><strong>Test -產生報告</strong></li>
<li><strong>Test -覆蓋率</strong></li>
<li>End</li>
</ol>
<p>這裡實作上很簡單，但是在選擇上有一些困難與試誤，稍微作個記錄。</p>
<ol>
<li><p>dotconver (棄選)</p>
<ul>
<li>似乎要綁定 resharper 的 lincese</li>
<li>有 30 天的限制，不知道會不會影響功能</li>
<li>不知道怎麼用 commandline 下載執行程式至 Github Action 執行實體上。</li>
</ul>
</li>
<li><p>vstest.console.exe (棄選)</p>
<ul>
<li><del>似乎只能在 windows 上執行</del></li>
<li>可以透過參數開始功能 <code>--collect:&quot;Code Coverage&quot;</code>，但產生的 .cover 檔 SonarCloud 不支援需要轉換格式</li>
<li>不知道如何將 .cover 轉換為 .coverxml ， 可能是 visual studio enter prise 才有的功能 ?</li>
</ul>
</li>
<li><p>opencover (coverlet)</p>
<ul>
<li><del><code>/p:CoverletOutputFormat=opencover /p:CoverletOutput=./coverage/</code> 的語法不 Work</del></li>
<li><code>--collect:&quot;XPlat Code Coverage&quot;</code> 是比較新的參數用法，可以使用設定檔</li>
</ul>
</li>
</ol>
<p>因諸多原因，我最後選擇了 Opencover(Coverlet) 的作法，<br>記錄步驟如下，</p>
<p>首先要在測試專案上安裝 Nuget 套件 <code>coverlet.collector</code>。<br>然後執行以下語法產生覆蓋率報告。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet test ./test/Marsen.NetCore.Dojo.Tests/Marsen.NetCore.Dojo.Tests.csproj --settings coverage.xml</span><br></pre></td></tr></table></figure>

<p>coverage.xml 設定檔如下，這個檔案必須是 xml 檔，檔名並沒有限制 :<br>Configuration &gt; Format 請記得填寫 <code>opencover</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">RunSettings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">DataCollectionRunSettings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DataCollectors</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">DataCollector</span> <span class="attr">friendlyName</span>=<span class="string">&quot;XPlat code coverage&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Format</span>&gt;</span>opencover<span class="tag">&lt;/<span class="name">Format</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">DataCollector</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">DataCollectors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">DataCollectionRunSettings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RunSettings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最後至 <code>SonarCloud</code> 上設定 <code>sonar.cs.opencover.reportsPaths</code> 的路徑</p>
<p><img src="/images/2020/4/sonarqube_run_with_github_action_05.jpg" alt="result.trx"></p>
<p>最後的最後，就來個 Budget 大集合吧</p>
<p><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=bugs" alt="Bugs"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=code_smells" alt="Code Smells"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=coverage" alt="Coverage"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=duplicated_lines_density" alt="Duplicated Lines (%)"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=ncloc" alt="Lines of Code"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=sqale_rating" alt="Maintainability Rating"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=alert_status" alt="Quality Gate Status"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=reliability_rating" alt="Reliability Rating"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=security_rating" alt="Security Rating"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=sqale_index" alt="Technical Debt"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/measure?project=Marsen.NetCore.Dojo&metric=vulnerabilities" alt="Vulnerabilities"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/images/project_badges/sonarcloud-black.svg" alt="SonarCloud"></a><br><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/quality_gate?project=Marsen.NetCore.Dojo" alt="Quality gate"></a></p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/analysis/coverage/">Test Coverage &amp; Execution</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.johnwu.cc/article/docker-dotnet-coverage-report-generator.html">Docker 教學 - .NET Core 測試報告 (Coverlet + ReportGenerator)</a></li>
<li><a target="_blank" rel="noopener" href="https://discoverdot.net/projects/coverlet">Coverlet</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/agilix/collecting-test-coverage-using-coverlet-and-sonarqube-for-a-net-core-project-ef4a507d4b28">Collecting test coverage using Coverlet and SonarQube for a .net core project</a></li>
<li><a target="_blank" rel="noopener" href="https://codeburst.io/code-coverage-in-net-core-projects-c3d6536fd7d7">Code Coverage in .NET Core Projects</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/04/30/2020/sonarqube_run_with_github_action_coverage/" data-id="clzqmjgg7006s2sp01hz4gjjy" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/04/30/2020/sonarqube_run_with_github_action_coverage/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CI-CD/" rel="tag">CI&#x2F;CD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2020/sonarqube_run_with_github_action" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/27/2020/sonarqube_run_with_github_action/" class="article-date">
  <time datetime="2020-04-27T09:01:46.000Z" itemprop="datePublished">2020-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/27/2020/sonarqube_run_with_github_action/"> [實作筆記] Github 結合 SonarCloud 作代碼質量檢查</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>大概一年前我曾寫過一篇 Blog <a href="https://blog.marsen.me/2019/05/16/2019/opensource_with_sonarcloud/">[實作筆記] 讓 SonarQube 檢查你的代碼</a>，<br>沒什麼含金量，只是我個人用來記錄的筆記。<br>當初有一些問題沒有排除，加上工作一忙就沒有後續了。</p>
<p>我的理想目標是，每當我上 Code 到線上 Repo 時(Github)，<br>SonarCloud 可以幫我檢查代碼，跑跑測試覆蓋率，刷新一下 Budget，<br>如果有異常(覆蓋率下降、壞味道等…)最好再發個通知給我。<br>這些功能要怎麼作到呢 ?</p>
<p>然後我會實際用在我的 <a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo">SideProject</a> 上，<br>這個 Project 單純只是為了練習而生，<br>專注於我個人的測試項目，主要語言為 Csharp 也有一些 TypeScript 。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>首先先排序一下優先序吧。</p>
<ol>
<li>一定要可以執行代碼檢查</li>
<li>要能結合 CI ，我以 Github Action 作為我的主要 CI 工具</li>
<li>能夠跑測試並輸出測試報告</li>
<li>Badge 刷新</li>
<li>發通知</li>
</ol>
<p>這篇主要會說明如何結合 CI 執行代碼檢查。<br>執行代碼檢查就發現有一個問題， SonarCloud 一次只能對一種語言作檢查，<br>雖然我的專案裡有兩種語言，但是以 C# 佔大宗(93%)，所以調整一下目標，<br>先優先完成 C# 的代碼檢查、結合 CI 與輸出測試報告。<br>之後再進行 Typescript 的檢查與測試，最後通知有的話很棒，沒有也沒關係啦 :)。</p>
<h2 id="本機執行代碼檢查"><a href="#本機執行代碼檢查" class="headerlink" title="本機執行代碼檢查"></a>本機執行代碼檢查</h2><p>我本機的環境有兩個，一個是 Windows 一個 macOS，我這裡只討論 Windows 的作法，<br>然後我就要直上 CI 了，Github Action 我並不熟悉，但是我知道上面應該是執行 Linux like 的作業系統。</p>
<p>首先要在 SonarCloud 上建立 Project ，<br>可以參考 <a target="_blank" rel="noopener" href="https://sonarcloud.io/documentation/integrations/github/">Get started with GitHub.com</a> 快速建立。</p>
<p>Administrator &gt; Analysis Method</p>
<p><img src="/images/2020/4/sonarqube_run_with_github_action_02.jpg" alt="Analysis Method"></p>
<p>這裡要把 SonarCloud Automatic Analysis 的功能關掉。<br>SonarCloud 支援自動分析語言只有以下</p>
<p>ABAP, Apex, CSS, Flex, Go, HTML, JS, Kotlin, PHP, Python, Ruby, Scala, Swift, TypeScript, XML.</p>
<p>雖然有很多，但可惜並沒有 C# ，所以要先關掉，不然 Github Action 執行時會收到下面的錯誤。</p>
<p><code>You are running CI analysis while Automatic Analysis is enabled. Please consider disabling one or the other.</code></p>
<p>另外目前支援的 CI 服務有 Circle CI 與 Travis CI ，<br>一樣殘念的是沒有支援 Github Action 。<br>另外兩個選項目是 Other CI 與 Manually (手動) 。<br>我的前一篇文章就是使用手動的方式把檢查報告打到 SonarCloud。<br>雖然只隔一年，但 UI 介面上已經有些差距，我還是再作一次介紹。</p>
<p><img src="/images/2020/4/sonarqube_run_with_github_action_01.jpg" alt="Analysis Method"></p>
<p>首先先下載 SonarScanner，選擇正確的語言(Others)與 OS(Windows)後下載，<br>接著設定環境變數</p>
<p><img src="/images/2020/4/sonarqube_run_with_github_action_03.jpg" alt="Setting Path"></p>
<p>最後開啟 CMD 切換到專案目錄底下後。<br>執行語法，如果照著上述步驟，你可以在 Download 的按鈕下方找到語法，同時它會幫你填好 Token。</p>
<p>Begin</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet sonarscanner begin /k:&quot;$ProjectKey&quot; /o:&quot;$Organization&quot; /d:&quot;sonar.host.url=https://sonarcloud.io&quot; /d:&quot;sonar.login=&quot;$Sonar_Login</span><br></pre></td></tr></table></figure>

<p>MSBuild</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet build &quot;.\Marsen.NetCore.Dojo.Integration.Test.sln&quot;</span><br></pre></td></tr></table></figure>

<p>End</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet sonarscanner end /d:&quot;sonar.login=&quot;$Sonar_Login</span><br></pre></td></tr></table></figure>

<p><code>$ProjectKey</code> 與 <code>$Organization</code> 這兩個變數可以在 SonarCloud 的 Overview 介面的右下角找到，<br><code>$Sonar_Login</code> 則可以透過 <a target="_blank" rel="noopener" href="https://sonarcloud.io/account/security">Security</a> 設定。</p>
<p>執行命名完成後，大概幾秒內就可以在 SonarCloud 中看到結果了。</p>
<p>簡單總結一下</p>
<ol>
<li>你要有 SonarCloud</li>
<li>要下載 SonarScanner</li>
<li>依序執行 Begin &gt; MSBuild &gt; End</li>
</ol>
<p>另外有一些雷包，在這裡也記錄一下</p>
<ul>
<li>要安裝 Java (Java8)</li>
<li>執行語法的目錄底下不能有<code>sonar-project.properties</code><ul>
<li>不然會報錯 (sonar-project.properties files are not understood by the SonarScanner for MSBuild.)</li>
<li>我覺得應該是我的檔案內容有誤，但是還不知道怎麼修正。總之直接移除對我來說是可以 work 的。</li>
</ul>
</li>
</ul>
<h2 id="CI-執行代碼檢查"><a href="#CI-執行代碼檢查" class="headerlink" title="CI 執行代碼檢查"></a>CI 執行代碼檢查</h2><p>同上面的概念，只要讓你的 CI Server 在執行的過程中依序執行 Begin &gt; MSBuild &gt; End 即可，<br>參考 Github Action 的 yaml 檔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#上略</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Dotnet</span> <span class="string">Sonarscanner</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">dotnet</span> <span class="string">tool</span> <span class="string">install</span> <span class="string">--global</span> <span class="string">dotnet-sonarscanner</span> <span class="string">--version</span> <span class="number">4.8</span><span class="number">.0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SonarScanner</span> <span class="string">Begin</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">dotnet</span> <span class="string">sonarscanner</span> <span class="string">begin</span> <span class="string">/k:&quot;Marsen.NetCore.Dojo&quot;</span> <span class="string">/o:&quot;marsen-github&quot;</span> <span class="string">/d:&quot;sonar.host.url=https://sonarcloud.io&quot;</span> <span class="string">/d:&quot;sonar.login=&quot;$SONAR_LOGIN</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">with</span> <span class="string">dotnet</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">dotnet</span> <span class="string">build</span> <span class="string">&quot;.\Marsen.NetCore.Dojo.Integration.Test.sln&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SonarScanner</span> <span class="string">End</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">dotnet</span> <span class="string">sonarscanner</span> <span class="string">end</span> <span class="string">/d:&quot;sonar.login=&quot;$SONAR_LOGIN</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">SONAR_LOGIN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.SONAR_LOGIN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>這裡要注意的是，<br>首先每次你都需要安裝 Dotnet Sonarscanner ，<br>其實我不清楚 Github Action 背後的機制，但是我猜測應該是用到容器化的技術，<br>每次 CI 執行時都會起一個實體(這個可設定，<del>但是 Linux Like 的 OS 又快又便宜，就別考慮 Windows 了吧</del>請<a target="_blank" rel="noopener" href="https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners">參考</a>)<br>所以每次都要重頭安裝相關的軟體，比如 : Dotnet Sonarscanner 。</p>
<p>另外一點是，環境變數的設定，可以看到最後面的 <code>env</code> 變數。<br>這個是機制是將 CI 的設定傳到實體的環境變數之中。<br>在 yaml 中綁定要使用 <code>$+變數名</code> EX: <code>SONAR_LOGIN</code><br>其它的變數，你可以在 Github 的 <a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/settings/secrets">Secrets</a> 頁面設定。<br>另外 Github 有些預設的<a target="_blank" rel="noopener" href="https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables">變數</a>。<br>更多資訊可以<a target="_blank" rel="noopener" href="https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets#in-this-article">參考</a></p>
<p>設定成功後，每次進 Code 就能看到代碼的壞味道、重複或是資安風險等資訊囉。<br>可以參觀一下<a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo">我的專案</a>。</p>
<p><a target="_blank" rel="noopener" href="https://sonarcloud.io/dashboard?id=Marsen.NetCore.Dojo"><img src="https://sonarcloud.io/api/project_badges/quality_gate?project=Marsen.NetCore.Dojo" alt="Quality gate"></a></p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://sonarcloud.io/documentation/integrations/github/">Get started with GitHub.com</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/marketplace/actions/sonarcloud-scan">SonarCloud Scan</a></li>
</ul>
<h2 id="補充"><a href="#補充" class="headerlink" title="補充"></a>補充</h2><ul>
<li><a target="_blank" rel="noopener" href="https://studyhost.blogspot.com/2020/07/azure-devops-in-action-build-pipeline_26.html?fbclid=IwAR2PXmn_O91Z_duGpn5_z-tKAzvtZGc147omxtCkZDNk0xGRSwKqKRofy3M">Azure DevOps in Action - 在 Build Pipeline 當中加入自動化程式碼檢查</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/04/27/2020/sonarqube_run_with_github_action/" data-id="clzqmjgg7006q2sp01as10l9e" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/04/27/2020/sonarqube_run_with_github_action/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CI-CD/" rel="tag">CI&#x2F;CD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2020/iis_reverse_proxy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/24/2020/iis_reverse_proxy/" class="article-date">
  <time datetime="2020-04-24T02:31:22.000Z" itemprop="datePublished">2020-04-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/24/2020/iis_reverse_proxy/"> [實作筆記] 使用 IIS 作為 Reverse Proxy Server</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h2><ol>
<li>作業系統為 Windows 10</li>
<li>IIS 的版本為 10.0.18362.1</li>
<li>前端使用 nodejs 開發了一個網站，會在 localhost:3000 執行，提供 UI</li>
<li>使用 dotnet core 開發了一個網站，在 IIS 上執行，用來提供 Api</li>
<li>透過鎖 Host 的方式 dotnet core 的網站綁定在 <code>http://dev.api.test</code></li>
</ol>
<h2 id="目標"><a href="#目標" class="headerlink" title="目標"></a>目標</h2><ol>
<li>即使只有開發階段，我也不想看到 localhost:3000 作為我的網址</li>
<li>我想看到 <code>http://dev.site.test</code> 作為我的站台</li>
</ol>
<h2 id="本文"><a href="#本文" class="headerlink" title="本文"></a>本文</h2><p>首先，鎖 Host <code>127.0.0.1 dev.site.test</code>，<br>Host 的檔案路徑為 <code>C:\Windows\System32\drivers\etc</code>。</p>
<p>接下來請下載並安裝 <a target="_blank" rel="noopener" href="https://www.iis.net/downloads/microsoft/url-rewrite">URL Rewrite</a> 與 <a target="_blank" rel="noopener" href="https://www.iis.net/downloads/microsoft/application-request-routing">Application Request Routing</a>。</p>
<p>IIS 建立網站，繫結我設定為 <code>dev.site.test:80</code>，<br>應用程式集區我沒有特別處。<br>到 IIS 選取站台的 Url Rewrite 新增規則<br><img src="/images/2020/4/iis_reverse_proxy_01.jpg" alt="到 IIS 選取站台的 Url Rewrite 新增規則"><br>選取 Reverse Proxy 規則</p>
<p><img src="/images/2020/4/iis_reverse_proxy_02.jpg" alt="選取 Reverse Proxy 規則"></p>
<p>填寫 <code>localhost:3000</code></p>
<p><img src="/images/2020/4/iis_reverse_proxy_03.jpg" alt="填寫 `localhost:3000`"></p>
<p>這個時候前往 dev.site.test 就可以看到站台囉。</p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.iis.net/downloads/microsoft/url-rewrite">URL Rewrite</a></li>
<li><a target="_blank" rel="noopener" href="https://www.iis.net/downloads/microsoft/application-request-routing">Application Request Routing</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.to/petereysermans/hosting-a-node-js-application-on-windows-with-iis-as-reverse-proxy-397b">Hosting a Node.js application on Windows with IIS as reverse proxy</a></li>
<li><a target="_blank" rel="noopener" href="https://tecadmin.net/set-up-reverse-proxy-using-iis/">How to Setup Reverse Proxy on IIS with URL-Rewrite</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.miniasp.com/post/2009/04/13/Using-ARR-to-implement-Reverse-Proxy">如何利用 IIS7 的 ARR 模組實做 Reverse Proxy 機制</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/04/24/2020/iis_reverse_proxy/" data-id="clzqmjgg200632sp03xn98u46" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/04/24/2020/iis_reverse_proxy/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2020/todo_driven_develop_to_test_driven_develop_2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/04/2020/todo_driven_develop_to_test_driven_develop_2/" class="article-date">
  <time datetime="2020-04-04T10:22:40.000Z" itemprop="datePublished">2020-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/04/2020/todo_driven_develop_to_test_driven_develop_2/"> [實作筆記] 從 TDD 到 TDD ，Todo 到 Test 趨動開發(二)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>承<a href="https://blog.marsen.me/2020/02/26/2020/todo_driven_develop_to_test_driven_develop_1/">上篇</a></p>
<h2 id="異常處理的-Todo-項目"><a href="#異常處理的-Todo-項目" class="headerlink" title="異常處理的 Todo 項目"></a>異常處理的 Todo 項目</h2><p>異常處理有幾種狀況，<br>一種是回傳的狀態有異常，<br>一種是回傳的資料有異常，<br>最後一種是超乎預期的異常，<br>比如說 Http 通訊上本身有問題。</p>
<p>再進一步分析這三種狀況，<br>我會寫下以下幾種情境</p>
<ol>
<li>回傳的狀態有異常，記錄回傳的異常狀態，拋出 Exception</li>
<li>回傳的資料有異常，記錄回傳的異常資料，回傳空資料</li>
<li>超乎預期的異常，記錄異常資料, 拋出 Exception</li>
</ol>
<h2 id="測試案例-回傳的狀態有異常，記錄回傳的異常狀態，拋出-Exception"><a href="#測試案例-回傳的狀態有異常，記錄回傳的異常狀態，拋出-Exception" class="headerlink" title="測試案例 回傳的狀態有異常，記錄回傳的異常狀態，拋出 Exception"></a>測試案例 回傳的狀態有異常，記錄回傳的異常狀態，拋出 Exception</h2><p>新增測試案例<br>這裡複製之前的測試案例，<br>再透過 inline Method 還原 arrange 部份的代碼，<br>再修改成我們想要的測試案例。</p>
<p>這裡我們先驗証拋出 Exception</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case6_Query_Error_Result</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    _configService.GetAppSetting(<span class="string">&quot;pickup.service.url&quot;</span>)</span><br><span class="line">        .Returns(UrlMockResultError);</span><br><span class="line">    _storeSettingService.GetValue(_testStoreId, <span class="string">&quot;pickup.service&quot;</span>, <span class="string">&quot;loginId&quot;</span>).Returns(<span class="string">&quot;testId&quot;</span>);</span><br><span class="line">    _storeSettingService.GetValue(_testStoreId, <span class="string">&quot;pickup.service&quot;</span>, <span class="string">&quot;auth&quot;</span>).Returns(<span class="string">&quot;testAuth&quot;</span>);</span><br><span class="line">    target = <span class="keyword">new</span> PickupService(_configService, _storeSettingService);</span><br><span class="line"></span><br><span class="line">    Action act = () =&gt; target.GetUpdateStatus(_testStoreId, _testWaybillNo);</span><br><span class="line">    act.Should().Throw&lt;Exception&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Production Code 就單純很多了</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (obj.result == <span class="string">&quot;error&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一步我要驗証記錄 Log 的行為<br>出錯的時候應該呼叫 LogError 的方法</p>
<p>原本想直接驗証 LogError 有沒有被呼叫</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case7_Query_Error_Result_Should_LogError</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    GetPickupServiceWith(UrlMockResultError);</span><br><span class="line">    target.GetUpdateStatus(_testStoreId, _testWaybillNo);</span><br><span class="line">    _logger.Received().LogError(Arg.Any&lt;<span class="built_in">string</span>&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因為這裡會拋出 Exception ，<br>所以無法直接呼叫 GetUpdateStatus<br>要修改前一個測試</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case6_Query_Error_Result</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    GetPickupServiceWith(UrlMockResultError);</span><br><span class="line">    Action act = () =&gt; target.GetUpdateStatus(_testStoreId, _testWaybillNo);</span><br><span class="line">    act.Should().Throw&lt;Exception&gt;();</span><br><span class="line">    _logger.ReceivedWithAnyArgs().LogError(<span class="literal">default</span>(<span class="built_in">string</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 Production Code 很單純的加上 Logger 並調整建構子</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-   <span class="function"><span class="keyword">public</span> <span class="title">PickupService</span>(<span class="params">IConfigService configService, IStoreSettingService storeSettingService</span>)</span></span><br><span class="line"><span class="function">+   <span class="keyword">public</span> <span class="title">PickupService</span>(<span class="params">IConfigService configService, IStoreSettingService storeSettingService, ILogger logger</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>._configService = configService;</span><br><span class="line">        <span class="keyword">this</span>._storeSettingService = storeSettingService;</span><br><span class="line">+       <span class="keyword">this</span>._logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj.result == <span class="string">&quot;error&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">+       <span class="keyword">this</span>._logger.LogError(obj.result);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="回傳的資料有異常，記錄回傳的異常資料，回傳空資料"><a href="#回傳的資料有異常，記錄回傳的異常資料，回傳空資料" class="headerlink" title="回傳的資料有異常，記錄回傳的異常資料，回傳空資料"></a>回傳的資料有異常，記錄回傳的異常資料，回傳空資料</h2><p>測試案例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case7_Query_Error_Content</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">     GetPickupServiceWith(UrlMockContentError);</span><br><span class="line">     <span class="keyword">var</span> actual = target.GetUpdateStatus(_testStoreId, _testWaybillNo);</span><br><span class="line">     actual.Should().BeEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>調整代碼以通過測試</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(c.ErrorCode))</span><br><span class="line">+    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (c.Status)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment"><span class="doctag">///</span>/略…</span></span><br><span class="line">        &#125;</span><br><span class="line">+    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="超乎預期的異常，記錄異常資料-拋出-Exception"><a href="#超乎預期的異常，記錄異常資料-拋出-Exception" class="headerlink" title="超乎預期的異常，記錄異常資料, 拋出 Exception"></a>超乎預期的異常，記錄異常資料, 拋出 Exception</h2><p>測試</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case8_Query_Exception</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    GetPickupServiceWith(UrlMockException);</span><br><span class="line">    Action act = () =&gt; target.GetUpdateStatus(_testStoreId, _testWaybillNo);</span><br><span class="line">    act.Should().Throw&lt;Exception&gt;();</span><br><span class="line">    _logger.ReceivedWithAnyArgs().LogError(<span class="literal">default</span>(<span class="built_in">string</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Production Code 就直接整個用 try Catch 包起來再記 Log</p>
<h2 id="實務上的案例"><a href="#實務上的案例" class="headerlink" title="實務上的案例"></a>實務上的案例</h2><p>這裡補充一些實務上的情境，</p>
<ol>
<li>呼叫狀態查詢時，對方的 API 只允許同查詢 100 筆 WayBillNo</li>
<li>呼叫 API 後多了幾種文件外的狀態需要處理<ul>
<li>D → Finish</li>
<li>F → Finish</li>
<li>E → Abnormal</li>
</ul>
</li>
</ol>
<h2 id="單元測試現身"><a href="#單元測試現身" class="headerlink" title="單元測試現身"></a>單元測試現身</h2><p>現在我已經有一些整合測試作保護了，<br>但是想要修改或重構仍然很麻煩，<br>原因是我每次有新的情境就需要準備新的 Mock API(實務上我需要準備符合情境的 WayBillNo)，<br>透過 Todo 與整合測試，已經讓我們的代碼有了雛型。<br>在一切太晚之前，我們需撰寫單元測試。</p>
<h3 id="Do-TODO-建立單元測試"><a href="#Do-TODO-建立單元測試" class="headerlink" title="Do TODO 建立單元測試"></a>Do TODO 建立單元測試</h3><p>這裡小小提個 Visual Studio 2019 的小問題 ，<br>預設只會安裝 MSTest 的 Generator ，<br>這裡我要安裝 <a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=YowkoTsai.xUnitnetTestGenerator">XUnit 的 Generator</a> ，<br>安裝完成後再透過 Code Generator 產生第一個測試，紅燈。</p>
<p>當然這種 Generator 產生的 Code 不是實際要的測試案例<br>調整一下測試案例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ILogger logger = Substitute.For&lt;ILogger&gt;();</span><br><span class="line">IStoreSettingService storeSettingService = Substitute.For&lt;IStoreSettingService&gt;();</span><br><span class="line">storeSettingService.GetValue(Arg.Any&lt;<span class="built_in">long</span>&gt;(), <span class="string">&quot;pickup.service&quot;</span>, <span class="string">&quot;auth&quot;</span>).Returns(<span class="string">&quot;FakeAuth&quot;</span>);</span><br><span class="line">IConfigService configService = Substitute.For&lt;IConfigService&gt;();</span><br><span class="line">configService.GetAppSetting(<span class="string">&quot;pickup.service.url&quot;</span>).Returns(<span class="string">&quot;https://test.com/&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> target = <span class="keyword">new</span> PickupService(configService, storeSettingService, logger);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> actual = target.GetUpdateStatus(<span class="number">2</span>, <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt; &#123;<span class="string">&quot;TestWayBillNo&quot;</span>&#125;);</span><br><span class="line">actual.Should().BeEquivalentTo(<span class="keyword">new</span> List&lt;ShippingOrderUpdateEntity&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">new</span> ShippingOrderUpdateEntity</span><br><span class="line">    &#123;</span><br><span class="line">        AcceptTime = <span class="keyword">new</span> DateTime(<span class="number">2020</span>, <span class="number">03</span>, <span class="number">03</span>, <span class="number">17</span>, <span class="number">51</span>, <span class="number">20</span>),</span><br><span class="line">        OuterCode = <span class="string">&quot;TestWayBillNo&quot;</span>,</span><br><span class="line">        Status = StatusEnum.Finish</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Legacy-Code-相依-HttpClient"><a href="#Legacy-Code-相依-HttpClient" class="headerlink" title="Legacy Code 相依 HttpClient"></a>Legacy Code 相依 HttpClient</h3><p>大部份的功能我都可以透過 DI 的手段隔離，<br>但是之前的 Test Driven Develop 的方法並沒有將 HttpClient 轉換成可以隔離的物件。<br>另外一部份代碼是透過 Copy Paste 手法產生的代碼，所以也有可能會有 Legacy Code。<br>這裡我優先處理 HttpClient 。</p>
<p>首先我要重構一小段代碼，所幸之前的整合測試可以保護我這段重構</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+       <span class="keyword">internal</span> HttpClient HttpClient;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> DeliveryOrder = <span class="string">&quot;DeliveryOrder&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">new</span> List&lt;ShippingOrderUpdateEntity&gt;();</span><br><span class="line">-           <span class="keyword">var</span> httpClient = <span class="keyword">new</span> HttpClient();</span><br><span class="line">+           <span class="keyword">this</span>.HttpClient?? = <span class="keyword">new</span> HttpClient();</span><br></pre></td></tr></table></figure>

<p>在測試的保護下，我要逐步修改我的 HttpClient ，<br>好讓我的單元測能夠通過。<br>其實我目前的單元測試還未完成，所以可以先 Skip 掉，<br>等 HttpClient 隔離完成後再回頭完成單元測試。</p>
<h3 id="隔離-HttpClient"><a href="#隔離-HttpClient" class="headerlink" title="隔離 HttpClient"></a>隔離 HttpClient</h3><p>這裡我要回顧一下，之前在作 <a href="https://blog.marsen.me/2020/01/29/2020/tdd_pay_api/">Kata_Api_Pay</a> 的時候，<br>我在 Production Code 建立了 <code>IHttpClient</code> 的介面，<br>用於隔離 <code>HttpClient</code> 。<br>我可以延用 HttpClient 但是因為我未實作 <code>DefaultRequestHeaders</code> 欄位，<br>這會導致一些錯誤;<br>雖然我可以一併調整但是這樣我要同時面對兩份遺留代碼，<br>我認為這樣的風險太大，而且使用 <code>IHttpClient</code> 目前看起來出現一些問題。</p>
<ol>
<li>雖然抽出介面，但依賴在 <code>HttpClient</code> 之上，未來有功能不足或未實作 HttpClient 的功能就仍需要調整。</li>
<li>最初的目的其實是為了隔離，而隔離的目的是為了好測試，這些代碼卻放在 Production Code 上實在很奇怪。</li>
</ol>
<p>基於以上種種理由，我要重新作一次隔離。<br>要達到幾個目地。</p>
<ol>
<li>真正的與 <code>HttpClient</code> 解耦，未來再有用到 HttpClient 的任何方法&#x2F;欄位皆不影響即有代碼。</li>
<li>將這類的工具放到正確專案 <code>TestingToolkit</code> 之下，不再影響 Production Code</li>
</ol>
<p>首先允許測試專案存取 Production Code 的 Internal 欄位</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+       [assembly: InternalsVisibleTo(<span class="string">&quot;Marsen.NetCore.Dojo.Tests&quot;</span>)]</span><br><span class="line">        <span class="keyword">namespace</span> <span class="title">Marsen.NetCore.Dojo.Kata_PickupService</span></span><br></pre></td></tr></table></figure>

<p>下一步，偽造 HttpClient 的回傳值，<br>我們可以透過 HttpClient 的建構子作到這件事。<br>參考這篇<a target="_blank" rel="noopener" href="https://dev.to/n_develop/mocking-the-httpclient-in-net-core-with-nsubstitute-k4j">文章</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">target.HttpClient =</span><br><span class="line">    <span class="keyword">new</span> HttpClient(</span><br><span class="line">    <span class="keyword">new</span> MockHttpMessageHandler(JsonSerializer.Serialize(</span><br><span class="line">    <span class="keyword">new</span> ResponseEntity</span><br><span class="line">    &#123;</span><br><span class="line">        Result = <span class="string">&quot;&quot;</span>,</span><br><span class="line">        Content = <span class="keyword">new</span> List&lt;Content&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> Content</span><br><span class="line">            &#123;</span><br><span class="line">                ErrorCode = <span class="built_in">string</span>.Empty,</span><br><span class="line">                Status = Status.DONE,</span><br><span class="line">                lastStatusDate = <span class="string">&quot;2020-03-03&quot;</span>,</span><br><span class="line">                lastStatusTime = <span class="string">&quot;17:51:20&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">HttpStatusCode.OK));</span><br></pre></td></tr></table></figure>

<p>偽造 HttpClient 的回傳值後，我就可以把單元測試的部份完成，<br>案例蠻多的，但是大同小異也沒有什麼特別的技法，<br>就不多贅述。</p>
<p>稍微提一下，反而在寫 Unit Test 過程中，<br>發現了 Production Code 一些 Over Design 的代碼。</p>
<p>比如說，多餘的邏輯分支，在某些因果條件，跟本不可能被執行到的代碼。<br>我視作無用的代碼將他移除。</p>
<p>另外也有發現一些 Entity 在呼叫 API 的過程不會取用它的資料或欄位，<br>也許有得人會想要移除這些 Entity ，但我會傾向保留，<br>原因是這些 Entity 是在整合測試階段被趨動出來的，<br>雖然沒有用到而且會使代碼的覆蓋率下降，<br>但是我認為這些代碼很有可能再下一個階段就會被用到，<br>在不影響功能的情況我不會刻意移除。</p>
<p>整體而言，測試已 100% 覆蓋，<br>也記錄了如何從 Todo Driven 到 TDD 的想法與技巧。<br>最後整理一下代碼，<br>把 MockHttpMessageHandler 搬到 TestingToolkit。<br>最後回頭把 api Pay 對 HttpClient 的處理調整一下就大功告成啦。</p>
<h3 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h3><ul>
<li><a target="_blank" rel="noopener" href="https://dev.to/n_develop/mocking-the-httpclient-in-net-core-with-nsubstitute-k4j">https://dev.to/n_develop/mocking-the-httpclient-in-net-core-with-nsubstitute-k4j</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/04/04/2020/todo_driven_develop_to_test_driven_develop_2/" data-id="clzqmjgg900742sp0clyu1j2e" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/04/04/2020/todo_driven_develop_to_test_driven_develop_2/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TDD/" rel="tag">TDD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unit-Testing/" rel="tag">Unit Testing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2020/macbook_ssh_add_and_git_fork" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/09/2020/macbook_ssh_add_and_git_fork/" class="article-date">
  <time datetime="2020-03-09T18:02:31.000Z" itemprop="datePublished">2020-03-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/09/2020/macbook_ssh_add_and_git_fork/"> [實作筆記] Macbook SSH 設置與疑問 </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>最近轉換了一下跑道 ，<br>剛好又了一點時間就想說順便換一下 OS 學一點新東西，<br>就敗了一台 MacBook ，  這幾天就忙著整理開發環境  。<br>在 ssh 上卡住了點 ， 就作點記錄順便上來提問  。</p>
<h2 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h2><p>我安裝了 <a target="_blank" rel="noopener" href="https://git-fork.com/">git-fork</a> 作為我的 Git GUI 工具。<br>裡面有一個很方便的功能可以快速的設定 ssh ，</p>
<p><img src="/images/2020/3/030901_fork_setting_ssh.png" alt="fork"></p>
<p>於是我很輕鬆愉快的設定了一組 ssh key 我命名為 <code>MacBook</code><br>也可以很正常的在 fork 裡面作一些 git 的操作 ，<br>比如說 fetch push pull 等。</p>
<p>不過人在江湖飄， 哪有不挨刀。<br>身為一個開發者與一個 Git 的愛用者，<br>有很多情境是會離開 GUI 工具操作 Git 的 。<br>但是很奇怪，只要離開了 fork 我的 Git 部份指令就會失效，<br>錯誤訊息如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git@github.com: Permission denied (publickey).</span><br><span class="line">fatal: Could not <span class="built_in">read</span> from remote repository.</span><br><span class="line">Please make sure you have the correct access rights and the repository exists.</span><br></pre></td></tr></table></figure>

<p>很明顯是權限不足的原因。<br>但是我查找了 <code>~/.ssh</code> 資料夾 ，<br>我設定的 private key <code>MacBook</code> 確實存在。</p>
<p>所以我透過一個指令來取得更多資訊</p>
<p><code>ssh -vT git@github.com</code></p>
<p>輸出如下</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">marsen@MarsendeMacBook-Pro ~ % ssh -vT git@github.com</span><br><span class="line">OpenSSH_7.9p1， LibreSSL 2.7.3</span><br><span class="line">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class="line">debug1: /etc/ssh/ssh_config line 48: Applying options for *</span><br><span class="line">debug1: Connecting to github.com [192.30.253.112] port 22.</span><br><span class="line">debug1: Connection established.</span><br><span class="line">debug1: identity file /Users/marsen/.ssh/id_rsa type -1</span><br><span class="line">debug1: identity file /Users/marsen/.ssh/id_rsa-cert type -1</span><br><span class="line">中間省略...</span><br><span class="line">debug1: Trying private key: /Users/marsen/.ssh/id_ecdsa</span><br><span class="line">debug1: Trying private key: /Users/marsen/.ssh/id_ed25519</span><br><span class="line">debug1: Trying private key: /Users/marsen/.ssh/id_xmss</span><br><span class="line">debug1: No more authentication methods to try.</span><br><span class="line">git@github.com: Permission denied (publickey).</span><br></pre></td></tr></table></figure>

<p>幾個奇怪的地方<br>一個是 identity file 或是 Trying private key 的檔案我都找不到 ，<br>另一個奇怪的點是 <code>~/.ssh/MacBook</code> 這組我剛剛建立的 private key 明明存在 ，<br>我確找不到他顯示在 identity file 或是 Trying private key 的記錄之中<br>總而言之，最後的訊息仍然是</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git@github.com: Permission denied (publickey).</span><br></pre></td></tr></table></figure>

<h2 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h2><p>指令 <code>ssh-add -K MacBook</code> 執行後， 就可正常運作。<br>小小猜測一下 ， 應該是 fork 運作的環境與一般 terminal 的環境有所差異，<br>所以需要額外透過指令加上 private key 才能夠執行。</p>
<p>不過我仍有疑問， fork 的設定在什麼地方可以調整呢 ?<br>另一個問題是 log 裡面這些不存在 private key 是在哪裡設定的 ?<br>查找過 <code>/etc/ssh/ssh_config</code> 裡面並沒有相關的設定</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">debug1: Will attempt key: /Users/marsen/.ssh/id_rsa</span><br><span class="line">debug1: Will attempt key: /Users/marsen/.ssh/id_dsa</span><br><span class="line">debug1: Will attempt key: /Users/marsen/.ssh/id_ecdsa</span><br><span class="line">debug1: Will attempt key: /Users/marsen/.ssh/id_ed25519</span><br><span class="line">debug1: Will attempt key: /Users/marsen/.ssh/id_xmss</span><br></pre></td></tr></table></figure>

<p><del>希望有人能有答案或提供文件可以參考一下。<br>不求甚解繼續玩 Mac 去。</del></p>
<h2 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h2><p>20200407 : 在安裝 git-fork 的時候 ， 它會另外安裝一個 git 實體 ，<br>所以與 global 環境的 git 不會是同一個 ， 導致在 git-fork 的行為不一致 。<br>另外之所以使用 ssh 作為連線手段 ， 是因為以前使用 SourceTree 作為 Git Gui Tool 時<br>常常會 Https 的密碼過期而需要重新輸入 ， 如果信任 git-fork 的開發者 ，<br>可以考慮使用 Https 連線 ， 看起來 git-fork 會記錄你的連線資訊 ，<br>而不會在每次操作 git 時詢問你密碼。</p>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/03/09/2020/macbook_ssh_add_and_git_fork/" data-id="clzqmjgg300682sp0fzcb6oc1" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/03/09/2020/macbook_ssh_add_and_git_fork/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2020/todo_driven_develop_to_test_driven_develop_1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/26/2020/todo_driven_develop_to_test_driven_develop_1/" class="article-date">
  <time datetime="2020-02-26T02:40:14.000Z" itemprop="datePublished">2020-02-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/26/2020/todo_driven_develop_to_test_driven_develop_1/"> [實作筆記] 從 TDD 到 TDD ，Todo 到 Test 趨動開發(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>上次作完金流後，這次換作物流，<br>在開發的過程中首次全程用 TDD 進行(?)，<br>因為某些因素，測試沒有進版控，所以稍微記錄一下心路歷程。<br>但是那個 T 是什麼? 就請各位看下去了…</p>
<h2 id="需求說明"><a href="#需求說明" class="headerlink" title="需求說明"></a>需求說明</h2><p>出貨流程為:</p>
<ol>
<li>訂單成立</li>
<li>透過物流服務配號</li>
<li>出貨</li>
<li>透過物流服務查詢物流狀態</li>
<li>狀態正確，通知消費者取貨</li>
<li>狀態不正確，通知商家，人工處理。</li>
</ol>
<p>這次 TDD 進行的部份為流程上的第 4 步，<br>往下看我怎麼做的</p>
<p>整體流程如下</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>Step0 . 這次不是從無到有，而是在遺留代碼之中建立測試，<br>所以我會準備一些「<a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/commit/2e4e5ecffe96043b2c442cf468d90fc4d95c9fa4">遺留代碼</a>」來呈現我面臨的狀況。</p>
<p>Step1 . 這次 TDD 先不是 Test 而 TODO，<br>直接對 Production Code 寫下 Todo List，<br>這個 TODO 的過程其實就是一種分析，一種需求拆分。</p>
<p>這裡我先簡單拆成兩步，</p>
<ol>
<li>打 API 問狀態</li>
<li>將問到的資料轉換成回傳資料</li>
</ol>
<p>Step 2 . <a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/commit/aba8811b4b0a2c3888341997ad69183264f67ac8">隨著過程把 TODO 拆的更細</a></p>
<ol>
<li>打 API 問狀態<ol>
<li>建立 HttpClient</li>
<li>建立 auth</li>
<li>準備 HttpContent 資料</li>
<li>指定 API URL</li>
<li>呼叫</li>
</ol>
</li>
</ol>
<p>以往這個時候，我就會進開發了，<br>這次我不打算刻意改變我的開發習慣，<br>但是我會多作一件事，寫測試。<br>這個測試會直接呼叫我即將開發的方法，<br>而我的方法會真的去打 API 存取 DB 讀 Config Files 諸如此類的事情。</p>
<h2 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h2><h3 id="第一個測試，但是沒有-Assert"><a href="#第一個測試，但是沒有-Assert" class="headerlink" title="第一個測試，但是沒有 Assert"></a>第一個測試，但是沒有 Assert</h3><p>我目前對測試案例沒有任何的想法(這是個壞味道)，<br>但是我打算直接<a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/commit/12936d65ce60aec90c385716fe3fe90dfb8abad0">透過測試呼叫我的 Production Code</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case1_Just_Run</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> target = <span class="keyword">new</span> PickupService();</span><br><span class="line">    <span class="built_in">long</span> storeId = <span class="number">0</span>;</span><br><span class="line">    List&lt;<span class="built_in">string</span>&gt; waybillNo = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">    target.GetUpdateStatus(storeId, waybillNo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因為沒有想法，所以沒有 <code>Assert</code><br>這不算是測試，頂多是<strong>一個小工具</strong>可以隨時呼叫我的 Production Code 而已</p>
<h3 id="Do-Todo-建立-HttpClient"><a href="#Do-Todo-建立-HttpClient" class="headerlink" title="Do Todo 建立 HttpClient"></a><a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/commit/1c1102457355992c1e75fcf47846404d60310f3d">Do Todo 建立 HttpClient</a></h3><p>這裡依造我以前的開發習慣，直接開幹，<br>把 HttpClient new 出來，刪除 Todo Comment<br>Committed 然後發 Pull Request</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-            <span class="comment"><span class="doctag">///</span>/ TODO 1.建立 HttpClient</span></span><br><span class="line">+            <span class="keyword">var</span> httpClient = <span class="keyword">new</span> HttpClient();</span><br></pre></td></tr></table></figure>

<h3 id="Do-Todo-建立-auth"><a href="#Do-Todo-建立-auth" class="headerlink" title="Do Todo 建立 auth"></a><a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/commit/5f5b85ab3ff97170f5ce51fac71e01bac8779b9f">Do Todo 建立 auth</a></h3><p>通常在串接第三方服務的過程中，<br>第三方會提供沙盒(SandBob)作開發人員測試使用<br>這裡我加了一點遮罩，但實務上如果是沙盒的 auth 資訊<br>我可能會直接 Commit 進去(壞味道)。</p>
<p>注意!! 這時候還是 Production Code 喔<br>我可以在測試加個 TODO ，<br>未來這段應該被 Mock 而不是 Hard Code 寫死。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-           <span class="comment"><span class="doctag">///</span>/ TODO 2.建立 auth</span></span><br><span class="line">+           <span class="comment"><span class="doctag">///</span>/ TODO login id 抽參數</span></span><br><span class="line">+           httpClient.DefaultRequestHeaders.Add(<span class="string">&quot;login_id&quot;</span>, <span class="string">&quot;testId&quot;</span>);</span><br><span class="line">+           <span class="comment"><span class="doctag">///</span>/ TODO authorization 抽參數</span></span><br><span class="line">+           httpClient.DefaultRequestHeaders.Add(<span class="string">&quot;authorization&quot;</span>, <span class="string">&quot;testAuth&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Do-Todo-準備-HttpContent-資料"><a href="#Do-Todo-準備-HttpContent-資料" class="headerlink" title="Do Todo 準備 HttpContent 資料"></a><a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/commit/cde2c5b36c5848e58feb499656ae4da81c7bd3fc">Do Todo 準備 HttpContent 資料</a></h3><p>準備 HttpContent 有很多種方式，<br>這裡我選擇 StringContent 來實作。<br>所以要包含物件轉換成 Json String 的行為，<br>需要參考 JsonSerializer 。<br>如果是不太熟悉的開發人員可能會另開 TODO，<br>但是我這裡就一次性的作掉了 。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-           <span class="comment"><span class="doctag">///</span>/ TODO 3.準備 HttpContent 資料</span></span><br><span class="line"></span><br><span class="line">+           <span class="keyword">var</span> requestContent = JsonSerializer.Serialize(<span class="keyword">new</span> &#123; Type = <span class="string">&quot;DeliveryOrder&quot;</span>, waybillNo &#125;);</span><br><span class="line">+           <span class="keyword">var</span> httpContent = <span class="keyword">new</span> StringContent(requestContent, Encoding.UTF8, <span class="string">&quot;application/json&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Take-a-break"><a href="#Take-a-break" class="headerlink" title="Take a break"></a>Take a break</h3><p>稍微休息一下，這裡我的開發流程基本上沒有改變，<br>除了多寫一個(整合)測試，而且每次都會稍微跑一下測試，<br>這個測試其實沒有 Assert ，唯一的幫助只能驗証執行方法時沒有 Exception</p>
<h3 id="重構"><a href="#重構" class="headerlink" title="重構"></a>重構</h3><p>重構應該落在開發之中，我看到兩個小問題</p>
<ol>
<li>我會 inline 掉多餘的參數 requestContent</li>
<li>Type &#x3D; “DeliveryOrder” 對我來說是個 magic variable ，我會加 TODO 預計未來抽成常數(壞味道，Why not now ?)</li>
</ol>
<h3 id="Do-TODO-4-指定-API-URL-TODO-5-呼叫"><a href="#Do-TODO-4-指定-API-URL-TODO-5-呼叫" class="headerlink" title="Do TODO 4.指定 API URL &amp; TODO 5.呼叫"></a><a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/commit/fb3fb84442b074838785d3155c6d79969fd5ba30">Do TODO 4.指定 API URL &amp; TODO 5.呼叫</a></h3><p>修改代碼如下，拿到第一個紅燈<br>因為我沒有指定 url</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span>/ TODO 4.指定 API URL</span></span><br><span class="line"><span class="built_in">string</span> url=<span class="built_in">string</span>.Empty;</span><br><span class="line"><span class="keyword">var</span> responseMessage = httpClient.PostAsync(url, httpContent).Result;</span><br></pre></td></tr></table></figure>

<p>為了修正這個紅燈我會指定 url，<br>實務上我會使用沙盒的 url ，<br>這裡我先用 mock api 取代 ，<br>mock api 的服務為 <a target="_blank" rel="noopener" href="https://www.mocky.io/">Mocky</a>，<br>類似的服務很多，也不是本篇的重點，就不贅述了。</p>
<p>這次一次處理掉兩個 TODO ，<br>表示當初我 TODO Task 切的過小，<br>下次可以切大一些。</p>
<p>不算壞味道，就當學個經驗。</p>
<h3 id="第一次-TODO-作完之後"><a href="#第一次-TODO-作完之後" class="headerlink" title="第一次 TODO 作完之後"></a>第一次 TODO 作完之後</h3><p>當初規劃的 TODO Task 都作完了，<br>但是其實工作並沒有完成。</p>
<p>我會再作進一步的分析，<br>可以看到原本的 TODO 產生了更多的 TODO ，<br>另外打完 API 後的處理也是個問題。</p>
<p>這邊要用到 <a href="https://blog.marsen.me/2018/12/27/2018/csm/to_sum_up_scrum/">walking skeleton</a> 的概念，<br>簡單說就是，先打通再迭代。</p>
<p>前面產生的 TODO 項目並不是「最」重要的，<br>我應該先處理回傳的資料，讓整件事情串通。<br>開立 TODO 如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ <span class="comment"><span class="doctag">///</span>/ TODO Parse Response Entity</span></span><br><span class="line">+ <span class="comment"><span class="doctag">///</span>/ TODO Switch Status</span></span><br><span class="line">+ <span class="comment"><span class="doctag">///</span>/ TODO Return ShippingOrderUpdateEntity List</span></span><br></pre></td></tr></table></figure>

<p>可以得知，我最終會回傳一包 List，<br>這個時候我可以 Assert 了</p>
<h3 id="修改第一個測試案例"><a href="#修改第一個測試案例" class="headerlink" title="修改第一個測試案例"></a>修改第一個測試案例</h3><p>這個階段我開始撥雲見日，我要很明確的寫下第一個測試案例，<br>第一個案例我會直接作 Happy Case ，<br>也就是目前的呼叫的 API<br>只打一筆，回傳 Done 的資料。</p>
<p>這裡進一步作需求分析，<br>呼叫完 API 我會收到一大包 JSON 資料，<br>需要轉成我可以處理的物件，<br>其中最重要的欄位 lastStatusId 會回傳各種狀態，</p>
<ul>
<li>DONE</li>
<li>FAIL</li>
<li>Arrived</li>
<li>Shipping</li>
<li>SMS</li>
<li>Expiry</li>
</ul>
<p>我只處理</p>
<ul>
<li>已取貨(DONE) 系統狀態為 Finish</li>
<li>失敗(FAIL、Expiry) 系統狀態為 Abnormal</li>
<li>貨到待取(Arrived) 系統狀態為 Arrived</li>
<li>出貨中(Shipping) 系統狀態為 Processing</li>
</ul>
<p>分析後，我的測項將會是向 API 循問一筆資料<br>且回傳一筆為 Done 的 ShippingOrderUpdateEntity 給我。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case1_Query_Done_waybillNo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> target = <span class="keyword">new</span> PickupService();</span><br><span class="line">    <span class="built_in">long</span> storeId = <span class="number">1</span>;</span><br><span class="line">    List&lt;<span class="built_in">string</span>&gt; waybillNo = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt; &#123;<span class="string">&quot;TEST2002181800010&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">var</span> actual = target.GetUpdateStatus(storeId, waybillNo).FirstOrDefault().Status;</span><br><span class="line">    actual.Should().Be(StatusEnum.Finish);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="拿到紅燈-，Do-TODO-Parse-Response-Entity"><a href="#拿到紅燈-，Do-TODO-Parse-Response-Entity" class="headerlink" title="拿到紅燈 ，Do TODO Parse Response Entity"></a>拿到紅燈 ，<a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/commit/38b41170115d3114953bfc91746ff3342c26dbc9">Do TODO Parse Response Entity</a></h3><p>如果是 Test Driven 我可能會速解再加案例，<br>但是我現在是 Todo Driven 所以造著 Todo 作事，<br>透過 json2csharp 快速產生 Entity 來轉置 JSON 資料。</p>
<h3 id="如何從-T-odo-DD-到-T-est-DD"><a href="#如何從-T-odo-DD-到-T-est-DD" class="headerlink" title="如何從 T(odo)DD 到 T(est)DD"></a>如何從 T(odo)DD 到 T(est)DD</h3><p>寫到這裡我已經開始感覺 Todo 的挶限性了，<br>由於這個方法職責不分，所以要測試是困難的，<br>但是 Todo 的作法是無法趨動改變的。</p>
<p>現在開始，試著把每個 Todo Task 改變成 Test Case</p>
<h3 id="第二個測試案例開始之前"><a href="#第二個測試案例開始之前" class="headerlink" title="第二個測試案例開始之前"></a>第二個測試案例開始之前</h3><p>再次說明一下商務需求，我可以提供 waybillNo 向 API 循問物流的狀態。<br>理想上我會擁有一堆不同貨態的 waybillNo ，剛好可以作我測試的案例<br>但是在實務上，我拿不到這些案例， 我折衷的作法是透過 Dummy API 來偽裝回傳值。<br>這仍是整合測試的一種，雖然我可以 Mock API 的回傳值，<br>但在網路狀況異常下，測試仍會紅燈</p>
<p>在作 Dummy API 的前提下，要能抽換 URL<br>所以我會先作 TODO url 抽參數</p>
<p>重構如下:</p>
<p>Production Code</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-        <span class="comment"><span class="doctag">///</span>/ TODO url 抽參數</span></span><br><span class="line">-        <span class="comment"><span class="doctag">///</span>/ string url= &quot;http://www.mocky.io/v2/********&quot;;</span></span><br><span class="line">-        <span class="built_in">string</span> url = <span class="string">&quot;http://www.mocky.io/v2/********&quot;</span>;</span><br><span class="line">+        <span class="built_in">string</span> url = <span class="keyword">this</span>._configService.GetAppSetting(<span class="string">&quot;pickup.service.url&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>Test Mock Return Value</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> configService = Substitute.For&lt;IConfigService&gt;();</span><br><span class="line">configService.GetAppSetting(<span class="string">&quot;pickup.service.url&quot;</span>)</span><br><span class="line">        .Returns(<span class="string">&quot;http://www.mocky.io/v2/********&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> target = <span class="keyword">new</span> PickupService(configService);</span><br></pre></td></tr></table></figure>

<h3 id="進一步增新測試的可讀性"><a href="#進一步增新測試的可讀性" class="headerlink" title="進一步增新測試的可讀性"></a>進一步增新測試的可讀性</h3><p>可讀性真的是一個很抽象的觀念，之後有機會再深入探討<br>我的修改如下，主要的想法是「讓測試案例可以像對話般被閱讀」</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case1_Query_Done_waybillNo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> actual = QueryWithDoneWaybillNo();</span><br><span class="line">    actual.Should().Be(StatusEnum.Finish);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第二個測試案例-出貨中-Shipping"><a href="#第二個測試案例-出貨中-Shipping" class="headerlink" title="第二個測試案例 - 出貨中(Shipping)"></a><a target="_blank" rel="noopener" href="https://github.com/marsen/Marsen.NetCore.Dojo/commit/611c73975702605a7420c991327ca1e4ed45ad46">第二個測試案例 - 出貨中(Shipping)</a></h3><p>這裡就是用簡單的 Test Case 趨動 Production Code 的代碼生成</p>
<p>Test Code</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case2_Query_Shipping_waybillNo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> actual = QueryWithShippingWaybillNo();</span><br><span class="line">    actual.Should().Be(StatusEnum.Processing);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Production Code (部份)</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-           <span class="comment"><span class="doctag">///</span>/ TODO Switch Status</span></span><br><span class="line">-           <span class="comment"><span class="doctag">///</span>/ TODO Return ShippingOrderUpdateEntity List</span></span><br><span class="line">-           result.Add(<span class="keyword">new</span> ShippingOrderUpdateEntity &#123;Status = StatusEnum.Finish&#125;);</span><br><span class="line">+           <span class="keyword">foreach</span> (<span class="keyword">var</span> c <span class="keyword">in</span> obj.content)</span><br><span class="line">+           &#123;</span><br><span class="line">+               <span class="keyword">switch</span> (c.lastStatusId)</span><br><span class="line">+               &#123;</span><br><span class="line">+                   <span class="keyword">case</span> <span class="string">&quot;DONE&quot;</span>:</span><br><span class="line">+                       result.Add(<span class="keyword">new</span> ShippingOrderUpdateEntity &#123;Status = StatusEnum.Finish&#125;);</span><br><span class="line">+                       <span class="keyword">break</span>;</span><br><span class="line">+                   <span class="keyword">case</span> <span class="string">&quot;Shipping&quot;</span>:</span><br><span class="line">+                       result.Add(<span class="keyword">new</span> ShippingOrderUpdateEntity &#123;Status = StatusEnum.Processing&#125;);</span><br><span class="line">+                       <span class="keyword">break</span>;</span><br><span class="line">+               &#125;</span><br><span class="line">+           &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>順手再重構了一下測試，<br>希望能提高可讀性</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Case2_Query_Shipping_waybillNo</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> actual = QueryWaybillNoWith(UrlMockShipping);</span><br><span class="line">    actual.Should().Be(StatusEnum.Processing);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="剩下的測試案例"><a href="#剩下的測試案例" class="headerlink" title="剩下的測試案例"></a>剩下的測試案例</h3><ul>
<li>失敗(FAIL) 系統狀態為 Abnormal</li>
<li>失敗(Expiry) 系統狀態為 Abnormal</li>
<li>貨到待取(Arrived) 系統狀態為 Arrived</li>
</ul>
<h3 id="剩下的-TODO-項目"><a href="#剩下的-TODO-項目" class="headerlink" title="剩下的 TODO 項目"></a>剩下的 TODO 項目</h3><p>這個時候基本的功能都好了，來收拾一下剩下的 TODO 項目吧<br>主要都是取得設定值的功能，實務上這些設定值可能來自不同的服務<br>Database、Config Service 或 Setting API 等…<br>我在這裡先簡化成 <code>IStoreSettingService</code> 取值就好。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-           <span class="comment"><span class="doctag">///</span>/ TODO login id 抽參數</span></span><br><span class="line">-           httpClient.DefaultRequestHeaders.Add(<span class="string">&quot;login_id&quot;</span>, <span class="string">&quot;testId&quot;</span>);</span><br><span class="line"></span><br><span class="line">+           <span class="keyword">var</span> loginId = <span class="keyword">this</span>._storeSettingService.GetValue(storeId,<span class="string">&quot;pickup.service&quot;</span>,<span class="string">&quot;loginId&quot;</span>);</span><br><span class="line">+           httpClient.DefaultRequestHeaders.Add(<span class="string">&quot;login_id&quot;</span>, loginId);</span><br></pre></td></tr></table></figure>

<p>同時測試代碼也要修改，<br>注意這裡的 testId 其實是 Pickup Service 提供給我們的測試 Id<br>在 Production 你需要整合進你的 Database、Config Service 或 Setting API 裡<br>在整合測試可以直接 mock 它</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_storeSettingService.GetValue(_testStoreId, <span class="string">&quot;pickup.service&quot;</span>, <span class="string">&quot;loginId&quot;</span>).Returns(<span class="string">&quot;testId&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>Auth 也是相同的處理</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-           <span class="comment"><span class="doctag">///</span>/ TODO authorization 抽參數</span></span><br><span class="line">-           httpClient.DefaultRequestHeaders.Add(<span class="string">&quot;authorization&quot;</span>, <span class="string">&quot;testAuth&quot;</span>);</span><br><span class="line">+           <span class="keyword">var</span> auth = <span class="keyword">this</span>._storeSettingService.GetValue(storeId,<span class="string">&quot;pickup.service&quot;</span>,<span class="string">&quot;auth&quot;</span>);</span><br><span class="line">+           httpClient.DefaultRequestHeaders.Add(<span class="string">&quot;authorization&quot;</span>, auth);</span><br></pre></td></tr></table></figure>

<p>Testing Mock</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_storeSettingService.GetValue(_testStoreId, <span class="string">&quot;pickup.service&quot;</span>, <span class="string">&quot;auth&quot;</span>).Returns(<span class="string">&quot;testAuth&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="心得小結"><a href="#心得小結" class="headerlink" title="心得小結"></a>心得小結</h2><p>TDD 不一定要用單元測試,<br>你可以試著從 T(Todo) Driven Development 到 T(Test) Driven Development<br>思考一下你目前的開發方式，<br>不要急著 TDD ，想像一下你開發到什麼程度會想要驗証(測試)，<br>試著在這個時間點加上測試就好，<br>這樣的開發方式，會比較貼近你的開發方式，<br>同時也可以練習寫測試，你會發現很多問題。<br>比如說:</p>
<ul>
<li>你跟本沒有足夠了解需求，導致你寫不出驗收條件。</li>
<li>你根本不熟悉測試框架或是相關的 Library。</li>
<li>甚至你跟本不熟悉你賴以為生的開發工具與程式語言。</li>
<li>或是你跟本不會 Debug 跟 Google 而且以前你一直以為你會。</li>
<li>你把代碼搞得一蹋糊塗，而且沒有人愛你</li>
</ul>
<p>下一次試著先寫測試吧，改變一下自已的工作方式。<br>平順把你的開發方式轉換成 TDD 吧 。</p>
<p>下一篇我會透過整合測試，發現一些異常狀況，<br>並試著加上測試案例，並試著趨動。</p>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/02/26/2020/todo_driven_develop_to_test_driven_develop_1/" data-id="clzqmjgga00772sp0e9yme3kv" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/02/26/2020/todo_driven_develop_to_test_driven_develop_1/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TDD/" rel="tag">TDD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unit-Testing/" rel="tag">Unit Testing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2020/tdd_pay_api" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/29/2020/tdd_pay_api/" class="article-date">
  <time datetime="2020-01-29T04:46:14.000Z" itemprop="datePublished">2020-01-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/29/2020/tdd_pay_api/"> [實作筆記] 用 TDD 寫一個 API Pay </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="需求說明"><a href="#需求說明" class="headerlink" title="需求說明"></a>需求說明</h2><p>金流系統透過打 API 與第三方介接來進行付款，<br>為了追蹤金流，在打 API 的過程中，業務單位要求要帶著 RequestId 。<br>再進行付款。<br>而 RequestId 由另一個專門負責提供 RequestId 的 API 來提供。</p>
<p>整體流程如下:</p>
<ol>
<li><p>打 API 取得 RequestId</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#123;&#123;url&#125;&#125;/api/&#123;&#123;version&#125;&#125;/requestId</span><br></pre></td></tr></table></figure>
</li>
<li><p>組合付款資料與 RequestId</p>
</li>
<li><p>打 API 完成付款</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST &#123;&#123;url&#125;&#125;/api/&#123;&#123;version&#125;&#125;/pay/CreditCard/&#123;&#123;transationId&#125;&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="第一個-Case，Pay-的時候應該呼叫-GET-reguestId-1-次"><a href="#第一個-Case，Pay-的時候應該呼叫-GET-reguestId-1-次" class="headerlink" title="第一個 Case，Pay 的時候應該呼叫 GET reguestId 1 次"></a>第一個 Case，Pay 的時候應該呼叫 GET reguestId 1 次</h2><p>問題，我需要驗証 HttpClient 呼叫的 <code>url</code>與<code>次數</code>。</p>
<p>一開始會寫成這樣，</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay_should_Get_requestId</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> target = <span class="keyword">new</span> PaymentService();</span><br><span class="line">    target.Pay();</span><br><span class="line">    httpClient.Received().GetAsync(<span class="string">&quot;https://testing.url/api/v1/requestId&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我本來就預計使用 HttpClient 來呼叫 API,<br>但是直接使用 HttpClient 會直接產生耦合，<br>所以我建立一個介面來包裝它。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IHttpClient</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著馬上建立類別 <code>HttpClientProxy</code> 實作 <code>IHttpClient</code>,<br>這個時候我會知道我會使用 GetAsync 的方法，<br>所以我會讓 <code>IHttpClient</code> 長出這個同名方法，<br>實作很單純，就是呼叫 HttpClient().GetAsync 方法。</p>
<blockquote><p>幾個想法，<br>這樣算是 Proxy Pattern 嗎 ? 我覺得算是:P<br>另一點，這個階段我會擔心 HttpClient 的問題,<br>不處理是對的嗎 ?<br>如果不刻意處理的話 HttpClientProxy 好像會長不出來  </p>
</blockquote>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IHttpClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">Task&lt;HttpResponseMessage&gt; <span class="title">GetAsync</span>(<span class="params"><span class="built_in">string</span> requestUri</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HttpClientProxy</span> : <span class="title">IHttpClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task&lt;HttpResponseMessage&gt; <span class="title">GetAsync</span>(<span class="params"><span class="built_in">string</span> requestUri</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpClient().GetAsync(requestUri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成這階段的修改後，我才可以透過 Framework 來 Mock IHttpClient，<br>寫好的測試如下，順利拿到第一個紅燈:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay_should_Get_requestId</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    IHttpClient httpClient = Substitute.For&lt;IHttpClient&gt;();</span><br><span class="line">    <span class="keyword">var</span> target = <span class="keyword">new</span> PaymentService(httpClient);</span><br><span class="line">    target.Pay();</span><br><span class="line">    httpClient.Received().GetAsync(<span class="string">&quot;https://testing.url/api/v1/requestId&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>馬上修改 Production Code ，拿到綠燈。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PaymentService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IHttpClient _httpClient;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PaymentService</span>(<span class="params">IHttpClient httpClient</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _httpClient = httpClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Pay</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _httpClient.GetAsync(<span class="string">&quot;https://testing.url/api/v1/requestId&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第二個-Case，Pay-的時候應該呼叫-POST-Pay-CreditCard-1-次"><a href="#第二個-Case，Pay-的時候應該呼叫-POST-Pay-CreditCard-1-次" class="headerlink" title="第二個 Case，Pay 的時候應該呼叫 POST Pay CreditCard 1 次"></a>第二個 Case，Pay 的時候應該呼叫 POST Pay CreditCard 1 次</h2><p>測試案例:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay_should_Post_Pay_CreditCard</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    IHttpClient httpClient = Substitute.For&lt;IHttpClient&gt;();</span><br><span class="line">    <span class="keyword">var</span> target = <span class="keyword">new</span> PaymentService(httpClient);</span><br><span class="line">    target.Pay();</span><br><span class="line">    <span class="keyword">this</span>._httpClient.Received().PostAsync(<span class="string">&quot;https://testing.url/api/v1/pay/CreditCard&quot;</span>, Arg.Any&lt;HttpContent&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 Production Code</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Pay</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> readAsStringAsync = <span class="keyword">this</span>._httpClient.GetAsync(<span class="string">&quot;https://testing.url/api/v1/requestId&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>._httpClient.PostAsync(<span class="string">&quot;https://testing.url/api/v1/pay/CreditCard&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重構測試</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay_should_Get_requestId</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    WhenPay();</span><br><span class="line">    ShouldGetRequestId();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay_should_Post_Pay_CreditCard</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    WhenPay();</span><br><span class="line">    ShouldPayByCreditCard();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WhenPay</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> target = <span class="keyword">new</span> PaymentService(_httpClient);</span><br><span class="line">    target.Pay();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ShouldGetRequestId</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>._httpClient.Received(<span class="number">1</span>).GetAsync(<span class="string">$&quot;<span class="subst">&#123;_testingApiUrl&#125;</span>requestId&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ShouldPayByCreditCard</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>._httpClient.Received(<span class="number">1</span>).PostAsync(<span class="string">$&quot;<span class="subst">&#123;_testingApiUrl&#125;</span>pay/CreditCard&quot;</span>,</span><br><span class="line">        Arg.Any&lt;HttpContent&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第三個-Case，Pay-的時候應該先呼叫-Get-RequestId-再-POST-Pay-CreditCard"><a href="#第三個-Case，Pay-的時候應該先呼叫-Get-RequestId-再-POST-Pay-CreditCard" class="headerlink" title="第三個 Case，Pay 的時候應該先呼叫 Get RequestId 再 POST Pay CreditCard"></a>第三個 Case，Pay 的時候應該先呼叫 Get RequestId 再 POST Pay CreditCard</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay_should_Get_RequestId_Before_Post_Pay_CreditCard</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    WhenPay();</span><br><span class="line">    Received.InOrder(() =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        ShouldGetRequestId();</span><br><span class="line">        ShouldPayByCreditCard();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote><p>想法，有了第三個案例，我還需要前面兩個案例嗎 ?</p>
</blockquote>

<p>下一步，調整 ShouldPayByCreditCard 的 Assert 邏輯，<br>原因是實務上我必須將 RequestId 帶入 Post Pay 時的 HttpContent 裡面。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ShouldPayByCreditCard</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>._httpClient.Received(<span class="number">1</span>).PostAsync(<span class="string">$&quot;<span class="subst">&#123;_testingApiUrl&#125;</span>pay/CreditCard&quot;</span>,</span><br><span class="line">    Arg.Is&lt;HttpContent&gt;(x =&gt; x.ReadAsStringAsync().Result.Contains(_testRequestId)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Prodouction Code 因而長出 <code>PayEntity</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Pay</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> requestId = <span class="keyword">this</span>._httpClient.GetAsync(<span class="string">&quot;https://testing.url/api/v1/requestId&quot;</span>).Result.Content</span><br><span class="line">        .ReadAsStringAsync().Result;</span><br><span class="line">    HttpContent content = <span class="keyword">new</span> StringContent(</span><br><span class="line">    JsonSerializer.Serialize(</span><br><span class="line">        <span class="keyword">new</span> PayEntity</span><br><span class="line">        &#123;</span><br><span class="line">            RequestId = requestId</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>._httpClient.PostAsync(<span class="string">&quot;https://testing.url/api/v1/pay/CreditCard&quot;</span>, content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PayEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> RequestId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Case4-組合資料邏輯"><a href="#Case4-組合資料邏輯" class="headerlink" title="Case4 組合資料邏輯"></a>Case4 組合資料邏輯</h2><h3 id="4-1-組合-PayEntity-的邏輯"><a href="#4-1-組合-PayEntity-的邏輯" class="headerlink" title="4.1 組合 PayEntity 的邏輯"></a>4.1 組合 PayEntity 的邏輯</h3><p>這次我假設外部的元件已組合好 <code>PayEntity</code> 傳入 PaymentService.Pay 方法，<br>唯一的組合邏輯就只剩 RequestId。<br>至於外部的 PayEntity 組合邏輯如何用 TDD 長出 Production Code 可以參考<a href="https://blog.marsen.me/2020/01/17/2020/tdd_with_parse_json/">這篇</a>。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WhenPay</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> target = <span class="keyword">new</span> PaymentService(_httpClient);</span><br><span class="line">    target.Pay(<span class="keyword">new</span> PayEntity());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Pay</span>(<span class="params">PayEntity payEntity</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">     <span class="keyword">var</span> requestId = <span class="keyword">this</span>._httpClient.GetAsync(<span class="string">&quot;https://testing.url/api/v1/requestId&quot;</span>).Result.Content</span><br><span class="line">         .ReadAsStringAsync().Result;</span><br><span class="line">     HttpContent content = <span class="keyword">new</span> StringContent(</span><br><span class="line">         JsonSerializer.Serialize(</span><br><span class="line">             payEntity.RequestId = requestId));</span><br><span class="line">      <span class="keyword">this</span>._httpClient.PostAsync(<span class="string">&quot;https://testing.url/api/v1/pay/CreditCard&quot;</span>, content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最後,將 api 的 url 也抽成可參數化。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PaymentServiceTests</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>._httpClient = Substitute.For&lt;IHttpClient&gt;();</span><br><span class="line">    <span class="keyword">this</span>._httpClient.GetAsync(Arg.Any&lt;<span class="built_in">string</span>&gt;()).ReturnsForAnyArgs(</span><br><span class="line">        Task.FromResult(</span><br><span class="line">            <span class="keyword">new</span> HttpResponseMessage</span><br><span class="line">            &#123;</span><br><span class="line">                Content = <span class="keyword">new</span> StringContent(_testRequestId)</span><br><span class="line">            &#125;));</span><br><span class="line">    <span class="keyword">this</span>._configure = Substitute.For&lt;IConfigure&gt;();</span><br><span class="line">    <span class="keyword">this</span>._configure.Setting(<span class="string">&quot;PayService.Url&quot;</span>).Returns(_testingApiUrl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Production Code</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PaymentService</span>(<span class="params">IHttpClient httpClient, IConfigure configure</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>._httpClient = httpClient;</span><br><span class="line">    <span class="keyword">this</span>._configure = configure;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Pay</span>(<span class="params">PayEntity payEntity</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> apiUrl = <span class="keyword">this</span>._configure.Setting(<span class="string">&quot;PayService.Url&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> requestId = <span class="keyword">this</span>._httpClient.GetAsync(<span class="string">$&quot;<span class="subst">&#123;apiUrl&#125;</span>requestId&quot;</span>).Result.Content</span><br><span class="line">        .ReadAsStringAsync().Result;</span><br><span class="line">    HttpContent content = <span class="keyword">new</span> StringContent(</span><br><span class="line">        JsonSerializer.Serialize(</span><br><span class="line">        payEntity.RequestId = requestId));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>._httpClient.PostAsync(<span class="string">$&quot;<span class="subst">&#123;apiUrl&#125;</span>pay/CreditCard&quot;</span>, content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h2><p>在 HttpClient 那邊卡蠻久的，用介面的方法包裝起來也不知道是否合適。<br>網路上有提供許多不同的作法，單元測試的 TDD 好像趨動不太出來 Production Code<br>是否需要加入整合測試，甚至是透過呼叫 Production Code 去打 API 作端到端測試，來趨動開發 ?<br>TDD 的 T 是不是不只是 Unit Test 呢 ?</p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://chrissainty.com/unit-testing-with-httpclient/">https://chrissainty.com/unit-testing-with-httpclient/</a></li>
<li><a target="_blank" rel="noopener" href="https://dotblogs.com.tw/jakeuj/2019/01/25/httpclient">https://dotblogs.com.tw/jakeuj/2019/01/25/httpclient</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.darkthread.net/blog/httpclient-sigleton/">https://blog.darkthread.net/blog/httpclient-sigleton/</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/01/29/2020/tdd_pay_api/" data-id="clzqmjgg8006x2sp0f3gc0ffm" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/01/29/2020/tdd_pay_api/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TDD/" rel="tag">TDD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unit-Testing/" rel="tag">Unit Testing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2020/book/better_by_atul_gawande" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/28/2020/book/better_by_atul_gawande/" class="article-date">
  <time datetime="2020-01-28T05:18:10.000Z" itemprop="datePublished">2020-01-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/28/2020/book/better_by_atul_gawande/">[閱讀筆記] 開刀房裡的沉思 -- 一位外科醫師的精進</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因為<a href="https://blog.marsen.me/2019/08/07/2019/book/apprenticeship_patterns/">「學徒模式」</a>在最後的章節多次提到這本書，<br>於是去了圖書館借來翻了一下，內容大多與醫療與醫生相關，<br>作者在醫療上如何追求卓越，精益求精 ?<br>作為一個開發人員，能否借鏡不同產業的精進旅程帶來一些反思 ?</p>
<p>簡單先作個小結，作者認為精進有三個基本要素</p>
<ol>
<li>努力不懈，簡單卻最困難，如何堅持?</li>
<li>務求正確, 這裡面臨了人性的挑戰，包含貪心、防衛心理和堅持與適時放棄</li>
<li>創新，勇於認錯、願意改變、見賢思齊</li>
</ol>
<p>引述一小段。</p>
<blockquote><p>我們不只是活在一個人的世界，<br>必須和別人一起工作，與科學一起進步，<br>也活在混亂、複雜的現實世界裡，而且任重道遠。<br>……<br>光是擔責任還不夠，選要想想如何能做得更好。</p>
</blockquote>

<h2 id="章節概要"><a href="#章節概要" class="headerlink" title="章節概要"></a>章節概要</h2><h3 id="CH-1-禍手"><a href="#CH-1-禍手" class="headerlink" title="CH 1 禍手"></a>CH 1 禍手</h3><p>簡單卻作不到的事。</p>
<h4 id="創新者的困境"><a href="#創新者的困境" class="headerlink" title="創新者的困境"></a>創新者的困境</h4><p>山姆維茲雖然推論出醫生不洗手是產婦致死的原兇，<br>但在同業同事間推動卻因批判與溝通而大大的失敗，<br>成為了悲劇英雄。</p>
<h4 id="現場執行的困境"><a href="#現場執行的困境" class="headerlink" title="現場執行的困境"></a>現場執行的困境</h4><ul>
<li>洗手的 SOP :首先缷下手錶，戒指…其次，用溫水潤濕雙手…最後沖水至少 30 秒…然後拿擦手紙…事實上沒有人能夠謹守這樣的步驟。</li>
<li>「不問你為什麼不洗手，而是問你為什麼不能洗手 ?」答案多半是:沒時間。</li>
<li>把病房變得像開刀房，使維持清潔變得容易，當他另謀高就後，原單位故態復萌、改革挫敗、白費功夫</li>
<li>「正向偏差」:透過內部推廣取代指示改變，詢問現場一線取代宣導與命令(現場改善、由下而上)</li>
</ul>
<blockquote><p>反思:<br>現場如何推動單元測試與 Clean Code ?<br>只靠個人 ? 明星開發者 ? 嚴格的規定 ? 無處不在的口號標語 ?  </p>
</blockquote>

<h3 id="Ch-6-薪事誰人知"><a href="#Ch-6-薪事誰人知" class="headerlink" title="Ch 6 薪事誰人知"></a>Ch 6 薪事誰人知</h3><p>醫師的困境是按件計酬，而存在與之對立的醫療保險業者，<br>原本醫療保險的立意是良善的，避免有的醫生漫天喊價。<br>但是時至今日，美國的醫療保險規則太過複雜，<br>引入第三方(保險業者)不但沒有幫助，反而變得更加複雜，<br>醫生無法得到合理的收費，沒有保險的病人無法得到醫療照護。</p>
<p>馬修．松頓保健計劃，在初期簡化與保險公司打交道的複雜性，<br>提昇了照護病人的成效，但在組織成長變大後，<br>諸多的規定與合約讓這個保險計劃也由保險集團接手，最終宣告結束。</p>
<h3 id="Ch-9-艾卜佳評分表"><a href="#Ch-9-艾卜佳評分表" class="headerlink" title="Ch 9 艾卜佳評分表"></a>Ch 9 艾卜佳評分表</h3><p>對人類來說，生產一直是一件困難的事。<br>對新生兒與孕婦在生產的過程中一不小心就有生命危險，<br>單鈎、產鉗、多達數十種的助產法、剖腹產等…</p>
<p>二十世紀複，隨著知識與器械的進步，研究卻表明醫院生產的新生兒死亡率高於產婆接生<br>生產流程的革新與標準化才進一步確保了新生兒的生存率<br>艾卜佳評分表在這當中擔任關鍵的角色，而且相當簡單。<br>膚色、哭聲、呼吸、四肢活動力、心跳次數等，簡單的分為 0、1、2 三種評分，<br>這讓主觀評量變成了客觀，有了評量才有改善的方向。<br>新生兒加護病房、產婦脊髓麻醉與胎兒心跳監視器也相應而生。</p>
<blockquote><p>反思 1 :<br>如何客觀評量績效 ?<br>書中說明產科的進步並不在嚴謹的「實證醫學」而是一個簡單的評分表。</p>
<p>那麼如何評量代碼質量 ?</p>
<ul>
<li>如何建立一個開發人員的評分表 ?</li>
<li>如何建立代碼的艾卜佳評分表呢 ?</li>
</ul>
<p>反思 2 :<br>產鉗在上個世紀是一門技藝，<br>儘管有研究表明剖腹產未必優於產鉗，但這門技藝仍就消失了。<br>如果產鉗是因為標準化的流程而消失，那軟體工程呢 ?<br>TDD 會是軟體工程裡的產鉗嗎 ? 2014 年的 <a target="_blank" rel="noopener" href="http://joe-dev.blogspot.com/2014/06/tdd-is-dead.html">TDD is died</a> 仍值得回味再三。</p>
<p>績效又該如何轉換成<a target="_blank" rel="noopener" href="https://earnings.dgbas.gov.tw/experience_sub_01.aspx">合理的收入</a>呢 ?</p>
</blockquote>

<h3 id="Ch-10-醫師的成績單"><a href="#Ch-10-醫師的成績單" class="headerlink" title="Ch 10 醫師的成績單"></a>Ch 10 醫師的成績單</h3><p>辛辛那提的醫生全力以赴，仍然只是中等平庸的醫院，<br>在本書中，醫生的技藝是呈現鐘型曲線。<br>作者表達的意思是，病人都想找最好的醫生，但在醫療的這個領域，<br>大多數都是平庸的。<br>在學徒模式書中，工程師是左傾的曲線，暗示大多數工程師都是拙劣的。<br><img src="/images/2020/1/better_by_atul_gawande_02.jpg" alt="左傾的曲線"></p>
<blockquote><p>反思<br>雖然手頭上沒有完整數據佐証，但是一般醫生至少需要 7 年的專業訓練，<br>而軟體工程業界，中途出家的非本科工程師比比皆是，<br>一線從業人員的水平參疵不齊，甚至有達克效應</p>
<p>這個行業本身歷史很短也很年輕，<br>影響範圍卻相當的廣大，<br>整個世界各行各業軟體都能參予其中。<br>缺乏調研、認証相關機構，但是我相信在未來這點能夠逐步改善</p>
</blockquote>

<p><img src="/images/2020/1/better_by_atul_gawande_01.jpg" alt="Dunning-Kruger Effec"></p>
<h2 id="其它章節"><a href="#其它章節" class="headerlink" title="其它章節"></a>其它章節</h2><ul>
<li>一個都不能漏</li>
<li>浴血</li>
<li>裸</li>
<li>纏訟</li>
<li>死刑室醫師</li>
<li>戰鬥</li>
<li>我的印度之旅</li>
</ul>
<h2 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h2><p>2020 過年寫下這篇文章，幾個事件與書共鳴，<br>反思記錄一下。</p>
<p>先是 2020 年<a target="_blank" rel="noopener" href="https://www.ptt.cc/bbs/Soft_Job/M.1579798528.A.0A9.html">館長的新聞</a> 。</p>
<p>館長已經揚言要提告了，他的需求是能同時十萬人上線的網站，<br>報價要 300 萬 + 30 萬壓測費，透過熟人介紹接案。<br>個人小小碎唸，在軟體業界常常有亂喊價，亂報時程的常態，<br>最後損失的往往是品質。</p>
<ul>
<li>盲信的後果，你沒有專業要如何相信對方呢 ? 反過來，你有專業要如何讓客戶相信你呢 ?</li>
<li>本例中館長揚言要提告工程師，但我疑惑為什麼不是中間人、接案公司或業務而是工程師 ? 窗口真的是工程師嗎 ?</li>
<li>壓測應該收多少錢 ? 10 萬人同時上線搶購，要作到什麼程度 ?</li>
<li>資安避險應收多少錢 ? 要作到什麼程度 ?</li>
<li>功能的缺失(帳務、發票 etc…)。如何驗收呢 ? 為何驗收失敗仍要行銷 ?</li>
</ul>
<p>第二個反思，公開透明的組織運作，將會成為組織是否能夠進步改善的關鍵<br>2020 的武漢肺炎是反向的例子，</p>
<ul>
<li>武漢市長表示未被授權, 依法不能批露疫情。</li>
<li>WHO 錯誤評估風險等級</li>
<li>ICAO 屏避支持台灣的帳號</li>
<li>陳秋實、面具人、口罩哥與黨與組織的各種輿情論戰。</li>
</ul>
<p>這件事還沒有結束，就不多作評論了。<br>後續再作追踪。</p>
<p>最後，今年我的侄子出生了，<br>因為剛好讀到產婦相關章節，所以特別有感<br>願他平安成長。</p>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/01/28/2020/book/better_by_atul_gawande/" data-id="clzqmjgis00i32sp0h2r4dq6l" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/01/28/2020/book/better_by_atul_gawande/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/" rel="tag">閱讀筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2020/tdd_with_parse_json" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/16/2020/tdd_with_parse_json/" class="article-date">
  <time datetime="2020-01-16T16:14:31.000Z" itemprop="datePublished">2020-01-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/16/2020/tdd_with_parse_json/"> [實作筆記] 記錄用 TDD 寫一個 Entity Parser </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="如何用-TDD-寫一個-Entity-Parser"><a href="#如何用-TDD-寫一個-Entity-Parser" class="headerlink" title="如何用 TDD 寫一個 Entity Parser"></a>如何用 TDD 寫一個 Entity Parser</h2><p>情境，假設有一包 JSON 檔案如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;FirstName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tian&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;LastName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tank&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;BirthDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1989/06/04&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>我想轉換成 C# Entity ，<br>這個 Entity 裡面包含兩個商業邏輯</p>
<ol>
<li>提供全名</li>
<li>提供年紀</li>
</ol>
<p>ex:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Name = Tank Tian</span><br><span class="line">Age = 35</span><br></pre></td></tr></table></figure>

<p>如何透過 TDD 的工序達到這個目標 ?</p>
<h3 id="Arrange"><a href="#Arrange" class="headerlink" title="Arrange"></a>Arrange</h3><p>傳入的 JSON 字串如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;FirstName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tian&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;LastName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tank&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;BirthDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1989/06/04&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Act"><a href="#Act" class="headerlink" title="Act"></a>Act</h3><p>執行 Parse 方法之後</p>
<h3 id="Assert"><a href="#Assert" class="headerlink" title="Assert"></a>Assert</h3><p>回傳一個 PersonEntity ，裡面的資料應該要是</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> PersonEntity &#123;</span><br><span class="line">    Name = <span class="string">&quot;Tian Tank&quot;</span></span><br><span class="line">    Age = <span class="number">30</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="工序"><a href="#工序" class="headerlink" title="工序"></a>工序</h3><h4 id="Step1"><a href="#Step1" class="headerlink" title="Step1"></a>Step1</h4><p>第一個案例，我會只驗証 Name 的組合邏輯</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CovertName</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Arrange</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Act</span></span><br><span class="line">    <span class="keyword">var</span> actual = _target.Parse(testJson).Name;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(<span class="string">&quot;Tian Tank&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Production Code 簡單寫可以這樣,<br>這個可以說是極致的 Baby Step 吧 ?</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">&quot;Tian Tank&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不過這個階段可以透過 IDE 工具長出 PersnaEntity</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PersonaEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step1-1"><a href="#Step1-1" class="headerlink" title="Step1.1"></a>Step1.1</h4><p>透過分析過需求，我們應該可以理解到 PersonaEntity.Name<br>其實是 FirstName 與 LastName 的組合，<br>所以我們可重構一下 Production Code，<br>這個步伐會大步一點，如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">&quot;Tian&quot;</span> + <span class="string">&quot;Tank&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step1-2"><a href="#Step1-2" class="headerlink" title="Step1.2"></a>Step1.2</h4><p>Oops !! 我拿到了一個紅燈，因為我忘了<strong>空白</strong>，<br>修改 Production Code 如下，得到綠燈</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">&quot;Tian&quot;</span> +<span class="string">&quot; &quot;</span>+ <span class="string">&quot;Tank&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step1-3"><a href="#Step1-3" class="headerlink" title="Step1.3"></a>Step1.3</h4><p>開始重構，這樣的 Baby Step 會不會真的太小步了 ?</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> firstName = <span class="string">&quot;Tian&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> lastName = <span class="string">&quot;Tank&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">    &#123;</span><br><span class="line">        Name = firstName + <span class="string">&quot; &quot;</span> + lastName</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step1-4"><a href="#Step1-4" class="headerlink" title="Step1.4"></a>Step1.4</h4><p>長出新的 Entity</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> firstName = <span class="string">&quot;Tian&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> lastName = <span class="string">&quot;Tank&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> originEntity = <span class="keyword">new</span> PersonaOriginEntity</span><br><span class="line">    &#123;</span><br><span class="line">        FirstName = firstName,</span><br><span class="line">        LastName = lastName</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">$&quot;<span class="subst">&#123;originEntity.FirstName&#125;</span> <span class="subst">&#123;originEntity.LastName&#125;</span>&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PersonaOriginEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> LastName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> FirstName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step1-5"><a href="#Step1-5" class="headerlink" title="Step1.5"></a>Step1.5</h4><p>重構</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> originEntity = <span class="keyword">new</span> PersonaOriginEntity</span><br><span class="line">    &#123;</span><br><span class="line">        FirstName = <span class="string">&quot;Tian&quot;</span>,</span><br><span class="line">        LastName = <span class="string">&quot;Tank&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">$&quot;<span class="subst">&#123;originEntity.FirstName&#125;</span> <span class="subst">&#123;originEntity.LastName&#125;</span>&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step1-6"><a href="#Step1-6" class="headerlink" title="Step1.6"></a>Step1.6</h4><p>改用 JSON Parser</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">//var originEntity = new PersonaOriginEntity</span></span><br><span class="line">   <span class="comment">//&#123;</span></span><br><span class="line">   <span class="comment">//    FirstName = &quot;Tian&quot;,</span></span><br><span class="line">   <span class="comment">//    LastName = &quot;Tank&quot;</span></span><br><span class="line">   <span class="comment">//&#125;;</span></span><br><span class="line">   <span class="keyword">var</span> originEntity = JsonSerializer.Deserialize&lt;PersonaOriginEntity&gt;(json);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">   &#123;</span><br><span class="line">       Name = <span class="string">$&quot;<span class="subst">&#123;originEntity.FirstName&#125;</span> <span class="subst">&#123;originEntity.LastName&#125;</span>&quot;</span></span><br><span class="line">   &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step1-7"><a href="#Step1-7" class="headerlink" title="Step1.7"></a>Step1.7</h4><p>移除無用代碼</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">//var originEntity = new PersonaOriginEntity</span></span><br><span class="line">   <span class="comment">//&#123;</span></span><br><span class="line">   <span class="comment">//    FirstName = &quot;Tian&quot;,</span></span><br><span class="line">   <span class="comment">//    LastName = &quot;Tank&quot;</span></span><br><span class="line">   <span class="comment">//&#125;;</span></span><br><span class="line">   <span class="keyword">var</span> originEntity = JsonSerializer.Deserialize&lt;PersonaOriginEntity&gt;(json);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">   &#123;</span><br><span class="line">       Name = <span class="string">$&quot;<span class="subst">&#123;originEntity.FirstName&#125;</span> <span class="subst">&#123;originEntity.LastName&#125;</span>&quot;</span></span><br><span class="line">   &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step2"><a href="#Step2" class="headerlink" title="Step2"></a>Step2</h4><p>第二個案例，我會驗証 Age 的計算邏輯</p>
<h4 id="Case-2-Age-是現在時間減去生日的年份差"><a href="#Case-2-Age-是現在時間減去生日的年份差" class="headerlink" title="Case 2. Age 是現在時間減去生日的年份差"></a>Case 2. Age 是現在時間減去生日的年份差</h4><p>首先，要如何處理 <strong>現在時間</strong> ??<br>一般的 Production Code 會用 <code>DateTime.Now</code><br>這是一個 struct 的 static 方法。</p>
<h4 id="Step2-1"><a href="#Step2-1" class="headerlink" title="Step2.1"></a>Step2.1</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CovertAge</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Arrange</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Act</span></span><br><span class="line">    <span class="keyword">var</span> actual = _target.Parse(testJson).Age;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Assert</span></span><br><span class="line">    actual.Should().Be(<span class="number">30</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>透過測試逼出 Age 欄位</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PersonaEntity</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>快速讓測試綠燈</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> originEntity = JsonSerializer.Deserialize&lt;PersonaOriginEntity&gt;(json);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">$&quot;<span class="subst">&#123;originEntity.FirstName&#125;</span> <span class="subst">&#123;originEntity.LastName&#125;</span>&quot;</span>,</span><br><span class="line">        Age = <span class="number">30</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step2-2"><a href="#Step2-2" class="headerlink" title="Step2.2"></a>Step2.2</h4><p>實作計算 Age</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonaEntity <span class="title">Parse</span>(<span class="params"><span class="built_in">string</span> json</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> originEntity = JsonSerializer.Deserialize&lt;PersonaOriginEntity&gt;(json);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PersonaEntity</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">$&quot;<span class="subst">&#123;originEntity.FirstName&#125;</span> <span class="subst">&#123;originEntity.LastName&#125;</span>&quot;</span>,</span><br><span class="line">        Age = originEntity.BirthDate.Year - DateTime.Now.Year</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個測試案例會在 2019 年為綠燈，而在 2020 年變為紅燈<br>這不是一個好的測試，好的測試應該符合可重複性(Repeatable)，<br>所以我們要試著 Mock 掉 DateTime.Now</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> SystemDateTime</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DateTime? _mockDateTime = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DateTime Now</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> =&gt; _mockDateTime ?? DateTime.Now;</span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">set</span> =&gt; _mockDateTime = <span class="keyword">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Reset</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _mockDateTime = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step2-3"><a href="#Step2-3" class="headerlink" title="Step2.3"></a>Step2.3</h4><p>改寫測試案例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CovertAgeTodayIs2019</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Arrange</span></span><br><span class="line">    SystemDateTime.Now = Convert.ToDateTime(<span class="string">&quot;2019/12/28&quot;</span>);</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Act</span></span><br><span class="line">    <span class="keyword">var</span> actual = _target.Parse(testJson).Age;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Assert</span></span><br><span class="line">    actual.Should().Be(<span class="number">30</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step2-4"><a href="#Step2-4" class="headerlink" title="Step2.4"></a>Step2.4</h4><p>Mock 時間後再寫一個測試案例</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CovertAgeTodayIs2020</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Arrange</span></span><br><span class="line">    SystemDateTime.Now = Convert.ToDateTime(<span class="string">&quot;2020/12/28&quot;</span>);</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Act</span></span><br><span class="line">    <span class="keyword">var</span> actual = _target.Parse(testJson).Age;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/Assert</span></span><br><span class="line">    actual.Should().Be(<span class="number">31</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="Step2-5"><a href="#Step2-5" class="headerlink" title="Step2.5"></a>Step2.5</h4><p>改用 Given When Then，<br>測試案例如下，這樣會比較<strong>好讀</strong>嗎?:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse_name</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    AfterParseJson().Name.Should().Be(<span class="string">&quot;Tian Tank&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse_age_today_is_2019</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    GiveTodayIs(<span class="string">&quot;2019/12/28&quot;</span>).Age.Should().Be(<span class="number">30</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">Fact</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse_age_today_is_2030</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    GiveTodayIs(<span class="string">&quot;2030/05/06&quot;</span>).Age.Should().Be(<span class="number">41</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="後續"><a href="#後續" class="headerlink" title="後續"></a>後續</h3><ul>
<li>如果未來有多新的欄位再逐步加上測試。</li>
<li>但在實務上我極有可能會同時驗証大量的欄位 ，比如說欄位是一對一的 Mapping</li>
<li>想省略 PersonaOriginEntity ，有可能用 Dynamic 嗎 ?</li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2020/01/16/2020/tdd_with_parse_json/" data-id="clzqmjgg8006z2sp0944v8kc7" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2020/01/16/2020/tdd_with_parse_json/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TDD/" rel="tag">TDD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Unit-Testing/" rel="tag">Unit Testing</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/15/">← 上一頁</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="page-number" href="/page/15/">15</a><span class="page-number current">16</span><a class="page-number" href="/page/17/">17</a><a class="page-number" href="/page/18/">18</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/17/">下一頁 →</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/08/12/2024/azure_function_toggle_virtual_machine/">[踩雷筆記] Azure Function 開關虛據機與錯誤排除</a>
          </li>
        
          <li>
            <a href="/2024/08/05/2024/mysql_partial_index_and_soft_delete/">[學習筆記] SQL 軟刪除與索引 (MySQL/MSSQL/PostgreSQL)</a>
          </li>
        
          <li>
            <a href="/2024/08/01/2024/bash_color/"> [實作筆記] Bash 輸出彩色技巧</a>
          </li>
        
          <li>
            <a href="/2024/07/30/2024/azure_virtual_machine_for_nvidia_error_records/">[實作筆記] 初體驗設定 Nvidia GPU 的 Azure VM -- 錯誤排除</a>
          </li>
        
          <li>
            <a href="/2024/07/03/2024/azure_virtual_machine_for_nvidia/">[實作筆記] 初體驗設定 Nvidia GPU 的 Azure VM</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">彙整</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">八月 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">六月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">五月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">四月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a><span class="archive-list-count">3</span></li><span id='list_archives2' style='display:none'><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">6</span></li></span><span id=''></span><span onclick="var d=document.getElementById('list_archives2'); d.style.display===''?d.style='display:none':d.style=''">toggle...</span></ul>
    </div>
  </div>


  
    <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/3.0/tw/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/tw/88x31.png" />
</a>
  <br />
This work is licensed under a 
<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/3.0/tw/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Taiwan License</a>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤雲</h3>
    <div class="widget tagcloud">
      <a href="/tags/Net-Framework/" style="font-size: 14.67px;">.Net Framework</a> <a href="/tags/API/" style="font-size: 11.33px;">API</a> <a href="/tags/AWS/" style="font-size: 13.33px;">AWS</a> <a href="/tags/Agile/" style="font-size: 17.33px;">Agile</a> <a href="/tags/CI-CD/" style="font-size: 19.33px;">CI/CD</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Coding-Standard/" style="font-size: 10px;">Coding Standard</a> <a href="/tags/Container/" style="font-size: 12px;">Container</a> <a href="/tags/Database/" style="font-size: 12.67px;">Database</a> <a href="/tags/Design-Pattern/" style="font-size: 10.67px;">Design Pattern</a> <a href="/tags/Docker/" style="font-size: 12px;">Docker</a> <a href="/tags/Entity-Framework/" style="font-size: 10.67px;">Entity Framework</a> <a href="/tags/Firebase/" style="font-size: 10px;">Firebase</a> <a href="/tags/Git/" style="font-size: 10.67px;">Git</a> <a href="/tags/Golang/" style="font-size: 11.33px;">Golang</a> <a href="/tags/Google/" style="font-size: 11.33px;">Google</a> <a href="/tags/GulpJs/" style="font-size: 10.67px;">GulpJs</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hexo/" style="font-size: 15.33px;">Hexo</a> <a href="/tags/IIS/" style="font-size: 10px;">IIS</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/Integrated-Testing/" style="font-size: 10px;">Integrated Testing</a> <a href="/tags/Jenkins/" style="font-size: 12px;">Jenkins</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 10.67px;">Linux</a> <a href="/tags/Mongodb/" style="font-size: 10px;">Mongodb</a> <a href="/tags/MsSQL/" style="font-size: 11.33px;">MsSQL</a> <a href="/tags/MsTest/" style="font-size: 10px;">MsTest</a> <a href="/tags/Mutation-Testing/" style="font-size: 10px;">Mutation Testing</a> <a href="/tags/Nodejs/" style="font-size: 15.33px;">Nodejs</a> <a href="/tags/OAuth/" style="font-size: 10px;">OAuth</a> <a href="/tags/OOP/" style="font-size: 11.33px;">OOP</a> <a href="/tags/Openshift/" style="font-size: 10.67px;">Openshift</a> <a href="/tags/PowerShell/" style="font-size: 11.33px;">PowerShell</a> <a href="/tags/React/" style="font-size: 12px;">React</a> <a href="/tags/Redis/" style="font-size: 10.67px;">Redis</a> <a href="/tags/SQL/" style="font-size: 12px;">SQL</a> <a href="/tags/Scrum/" style="font-size: 16.67px;">Scrum</a> <a href="/tags/Shell/" style="font-size: 10.67px;">Shell</a> <a href="/tags/Specflow/" style="font-size: 10px;">Specflow</a> <a href="/tags/StyleCop/" style="font-size: 10px;">StyleCop</a> <a href="/tags/TDD/" style="font-size: 16px;">TDD</a> <a href="/tags/Testing/" style="font-size: 14px;">Testing</a> <a href="/tags/Thread/" style="font-size: 10.67px;">Thread</a> <a href="/tags/Trello/" style="font-size: 10px;">Trello</a> <a href="/tags/TypeScript/" style="font-size: 13.33px;">TypeScript</a> <a href="/tags/Unit-Testing/" style="font-size: 18.67px;">Unit Testing</a> <a href="/tags/Unix/" style="font-size: 10.67px;">Unix</a> <a href="/tags/Vim/" style="font-size: 10px;">Vim</a> <a href="/tags/Visual-Studio/" style="font-size: 10px;">Visual Studio</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/post/" style="font-size: 10px;">post</a> <a href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" style="font-size: 20px;">實作筆記</a> <a href="/tags/%E6%99%82%E9%96%93%E7%AE%A1%E7%90%86/" style="font-size: 10.67px;">時間管理</a> <a href="/tags/%E6%B4%BB%E5%8B%95%E7%AD%86%E8%A8%98/" style="font-size: 12.67px;">活動筆記</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E7%AD%86%E8%A8%98/" style="font-size: 16px;">生活筆記</a> <a href="/tags/%E8%A8%98%E9%8C%84/" style="font-size: 11.33px;">記錄</a> <a href="/tags/%E8%B8%A9%E9%9B%B7%E7%AD%86%E8%A8%98/" style="font-size: 14.67px;">踩雷筆記</a> <a href="/tags/%E9%87%8D%E6%A7%8B/" style="font-size: 12px;">重構</a> <a href="/tags/%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/" style="font-size: 18px;">閱讀筆記</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Net-Framework/" rel="tag">.Net Framework</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API/" rel="tag">API</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWS/" rel="tag">AWS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Agile/" rel="tag">Agile</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI-CD/" rel="tag">CI&#x2F;CD</a><span class="tag-list-count">24</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/" rel="tag">Cache</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Coding-Standard/" rel="tag">Coding Standard</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Container/" rel="tag">Container</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/" rel="tag">Database</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design-Pattern/" rel="tag">Design Pattern</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Entity-Framework/" rel="tag">Entity Framework</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Firebase/" rel="tag">Firebase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google/" rel="tag">Google</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GulpJs/" rel="tag">GulpJs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IIS/" rel="tag">IIS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/" rel="tag">IO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Integrated-Testing/" rel="tag">Integrated Testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mongodb/" rel="tag">Mongodb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MsSQL/" rel="tag">MsSQL</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MsTest/" rel="tag">MsTest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mutation-Testing/" rel="tag">Mutation Testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/" rel="tag">Nodejs</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OAuth/" rel="tag">OAuth</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OOP/" rel="tag">OOP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openshift/" rel="tag">Openshift</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PowerShell/" rel="tag">PowerShell</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL/" rel="tag">SQL</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scrum/" rel="tag">Scrum</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Specflow/" rel="tag">Specflow</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/StyleCop/" rel="tag">StyleCop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDD/" rel="tag">TDD</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Testing/" rel="tag">Testing</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thread/" rel="tag">Thread</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Trello/" rel="tag">Trello</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unit-Testing/" rel="tag">Unit Testing</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unix/" rel="tag">Unix</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vim/" rel="tag">Vim</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Visual-Studio/" rel="tag">Visual Studio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html/" rel="tag">html</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/post/" rel="tag">post</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a><span class="tag-list-count">113</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%99%82%E9%96%93%E7%AE%A1%E7%90%86/" rel="tag">時間管理</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B4%BB%E5%8B%95%E7%AD%86%E8%A8%98/" rel="tag">活動筆記</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E7%AD%86%E8%A8%98/" rel="tag">生活筆記</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A8%98%E9%8C%84/" rel="tag">記錄</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B8%A9%E9%9B%B7%E7%AD%86%E8%A8%98/" rel="tag">踩雷筆記</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%87%8D%E6%A7%8B/" rel="tag">重構</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/" rel="tag">閱讀筆記</a><span class="tag-list-count">15</span></li></ul>
    </div>
  </div>


  
    

  
    <div class="widget-wrap">
    <h3 class="widget-title">多語系</h3>
    <div class="widget">
        <div id="ytWidget"></div>
    </div>
</div>
<script src="https://translate.yandex.net/website-widget/v1/widget.js?widgetId=ytWidget&pageLang=zh&widgetTheme=dark&autoMode=false" type="text/javascript"></script>
  
    <div class="widget-wrap">
    <h3 class="widget-title">BADGES</h3>
    <div class="widget">
        <a target="_blank" rel="noopener" href="https://bcert.me/bc/html/show-badge.html?b=uufxvngl">
            <img src="/images/2018/csm/seal-csm.png" alt="Certified ScrumMaster®">
        </a>
    </div>
</div>
  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 Marsen L.<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>



<script src="/js/sayings.js?v=0.js"></script>
  

<script src="/js/script.js?v=0.js"></script>

<div id="likecoin">
Please enable JavaScript to view the LikeCoin. :P
</div>
<script>

  (function(){
    var ifrm = document.createElement("iframe");
    ifrm.setAttribute("src", "https://button.like.co/in/embed/marsenlin/button?referrer=undefined");      
    ifrm.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox");
    ifrm.frameborder = "0";
    ifrm.scrolling = "no";
    (document.getElementById("likecoin").replaceChild(ifrm, document.getElementById("likecoin").childNodes[0]));
  })();

</script>
<script>

  var disqus_shortname = 'marsenlin';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

</script>

  </div>
    
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NTDGNJZ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

</body>
</html>