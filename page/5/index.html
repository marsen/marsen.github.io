<!DOCTYPE html>
<html>
<head>
  
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NTDGNJZ');</script>
<!-- End Google Tag Manager -->

  
<!-- Google Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RF47NNRE5G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RF47NNRE5G');
</script>
<!-- End Google Analytics -->

  
<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1885096025224905"
     crossorigin="anonymous"></script>
<!-- End Google AdSense -->



  <meta charset="utf-8">
  
  <title>Marsen&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Marsen&#39;s Blog">
<meta property="og:url" content="https://blog.marsen.me/page/5/index.html">
<meta property="og:site_name" content="Marsen&#39;s Blog">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Marsen L.">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Marsen&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
      
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300&display=swap" rel="stylesheet">
  
  
<link rel="stylesheet" href="/css/style.css">

  <meta property ="og:image" content="https://avatars1.githubusercontent.com/u/4269720?s=460&v=4" /> 
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="blog-banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Marsen&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle"></a>
          <div>
          <span style="width: 20px; height: 10px; background: linear-gradient(to bottom, #005BBB 50%, #FFD700 50%); text-align: center; color: white; font-size: 6px; font-weight: bold; line-height: 100px;">
            #StandWithUkraine
          </span>
          </div>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜尋"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.marsen.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2024/azure_function_python_deploy_with_devops_pipeline" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/08/13/2024/azure_function_python_deploy_with_devops_pipeline/" class="article-date">
  <time datetime="2024-08-13T03:17:42.000Z" itemprop="datePublished">2024-08-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/08/13/2024/azure_function_python_deploy_with_devops_pipeline/"> [踩雷筆記] Gitlab 整合 Azure DevOps Pipeline 以 python on Azure Functions 為例</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>我目前主要使用 GitLab 進行版本控制和持續集成(CI&#x2F;CD)，<br>主要整合 Google Cloud Platform (GCP) ，許多專案都運行在 GCP 上。<br>因商務需求最近開始探索第二朵雲 Azure。<br>雖然 Azure DevOps 也有提供 CI／CD 與 Repo 的解決方案;<br>但為了減少邏輯與認知負擔，我希望能將 GitLab 與 Azure DevOps Pipeline 進行整合。<br>具體來說，這次要在 Azure Functions 上部署 Python 應用程式，<br>我想要 RD 往 Gitlab 推送並執行 CI&#x2F;CD 就好，而不用特別因為服務在不同的雲上，而需要推送到不到同 Repo 中 。<br>面對這樣的需求，下面是我找到的解決方案。  </p>
<h2 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h2><p>以這次的例子來說，我需要控管 Azure 的 Serverless 解決方案「Azure Functions」的程式。<br>但是 Azure DevOps Pipeline 有相當高度的整合 Azure Cloud，只要能將程式推送到 Azure DevOps Repo，<br>部署就會相當簡單，<strong>而無需處理繁鎖的授權問題</strong>。<br>CI／CD 流程大致如下</p>
<ul>
<li>建立相對應的權限與憑証並提供給 Gitlab-Runner</li>
<li>RD 推送新版本程式給 Gitlab，觸發 Gitlab-Runner</li>
<li>Gitlab-Runner 執行測試、建置等相關作業後，部署到 Azure Functions</li>
</ul>
<ol>
<li><p><strong>設置 Azure DevOps Pipeline</strong>：</p>
<ol>
<li>選擇 New pipeline</li>
<li>Other Git</li>
<li>設定連線方式 &amp; 選擇分支<ol>
<li>Connection name (任意命名)</li>
<li>Repo URL 輸入 Gitlab Repo URL</li>
<li>User Name (任意命名)</li>
<li>Password &#x2F; Token Key (Gitlab PAT，需注意效期)</li>
</ol>
</li>
<li>使用「Azure Functions for Python」Template<ul>
<li>Build extensions</li>
<li>Use Python 3.10(可以更換合適的版本)</li>
<li>Install Application Dependencies</li>
<li>Archive files</li>
<li>Publish Artifact: drop</li>
</ul>
</li>
<li>追加 Agent job Task<ul>
<li>搜尋「Azure Functions Deploy」</li>
<li>填寫<ul>
<li>Azure Resource Manager connection<ul>
<li>Manage &gt; Service Connection &gt; New Service Connection &gt; Azure Resource Manager &gt; Service principal(automatic)<ul>
<li>Service connection name</li>
<li>Description (optional)</li>
</ul>
</li>
<li>也可以選擇 &gt; Service principal (manual)，需要先加上 App registrations 具體流程如下：<ul>
<li>在 Azure Portal 上建立一個新的 Azure Registration。</li>
<li>選擇 Certificates &amp; secrets，建立一組 Certificates &amp; secrets。</li>
<li>回到 Service principal (manual)<ul>
<li>Subscription Id</li>
<li>Subscription Name</li>
<li>Service Principal Id (App registrations Client secrets 的 Secret ID)</li>
<li>Service principal key (App registrations Client secrets 的　Value)</li>
<li>Tenant ID</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>App type (我的情況是選 Function App on Linux)</li>
<li>Azure Functions App name</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
<li><p><strong>配置 GitLab CI&#x2F;CD</strong>：</p>
<ul>
<li>在 GitLab 中，建立 <code>.gitlab-ci.yml</code> 如下：</li>
</ul>
 <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">debian:stable-slim</span></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">AZURE_PIPELINE_NAME:</span> <span class="string">&quot;dispatch-worker-deploy-pipeline&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apt-get</span> <span class="string">update</span> <span class="string">&amp;&amp;</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">curl</span> <span class="string">jq</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">trigger_pipeline:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">      json=$(curl -u $AZURE_DEVOPS_USER:$AZURE_DEVOPS_PAT \</span></span><br><span class="line"><span class="string">        -H &quot;Content-Type: application/json&quot; \</span></span><br><span class="line"><span class="string">        &quot;https://dev.azure.com/Aiplux/Inpas/_apis/build/definitions?api-version=6.0&quot;)</span></span><br><span class="line"><span class="string">      id=$(echo $json | jq -r --arg pipeline_name &quot;$AZURE_PIPELINE_NAME&quot; &#x27;.value[] | select(.name==$pipeline_name) | .id&#x27;)</span></span><br><span class="line"><span class="string">      echo -e &quot;\033[1;33mPipeline: $AZURE_PIPELINE_NAME ID is $id\033[0m&quot;</span></span><br><span class="line"><span class="string">      RESPONSE_CODE=$(curl -X POST &quot;https://dev.azure.com/My_Organization/My_Project/_apis/build/builds?api-version=6.0&quot; \</span></span><br><span class="line"><span class="string">        --data &#x27;&#123;&quot;definition&quot;: &#123;&quot;id&quot;: &#x27;$id&#x27;&#125;&#125;&#x27; \</span></span><br><span class="line"><span class="string">        -u $&#123;AZURE_DEVOPS_USER&#125;:$&#123;AZURE_DEVOPS_PAT&#125; \</span></span><br><span class="line"><span class="string">        -H &#x27;Content-Type: application/json&#x27; \</span></span><br><span class="line"><span class="string">        -w &quot;%&#123;http_code&#125;&quot; -o /dev/null -s)</span></span><br><span class="line"><span class="string">      if [ &quot;$RESPONSE_CODE&quot; -ne 200 ]; then</span></span><br><span class="line"><span class="string">        echo -e &quot;\033[1;31mRequest failed with status code $RESPONSE_CODE\033[0m&quot;</span></span><br><span class="line"><span class="string">        exit 1</span></span><br><span class="line"><span class="string">      fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">&#x27;$CI_COMMIT_BRANCH == &quot;main&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p> 可以看到 AZURE_DEVOPS_USER 與 AZURE_DEVOPS_PAT 兩個參數,<br> 可以在登入 Azure DevOps 後，在 User Settings &gt;&gt; Personal Access Tokens 取得,<br> 實務上由管理者提供，但是有時效性，仍然需要定期更新（１年），應該有更簡便的方法才對。</p>
</li>
</ol>
<p>完成以上的設定後，只要推送到 Gitlab Repo 的 main 分支，就會觸發 Azure DevOps Pipeline 部署。</p>
<h2 id="踩雷"><a href="#踩雷" class="headerlink" title="踩雷"></a>踩雷</h2><p>在整合過程中遇到了一個問題。<br>儘管使用了 Azure Pipeline 提供的官方模板，部署過程依然出現了錯誤。<br>具體而言並沒有明顯的錯誤，但是 Log 會記錄</p>
<blockquote>
<p><strong>1 function found</strong><br><strong>0 function loaded</strong></p>
</blockquote>
<p>導致 Azure Functions Apps 無法正常工作。</p>
<h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><p><a target="_blank" rel="noopener" href="https://github.com/Azure/azure-functions-python-worker/issues/708#issuecomment-765528255">參考</a></p>
<p>在 Azure Functions for Python 其中一步驟　Install Application Dependencies<br>Template 如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python3.6 -m venv worker_venv</span><br><span class="line">source worker_venv/bin/activate</span><br><span class="line">pip3.6 install setuptools</span><br><span class="line">pip3.6 install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>需要修改成才能作用，不確定 Azure 會不會提出修正或新的 template</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python3.10 -m venv .python_packages</span><br><span class="line">source .python_packages/bin/activate</span><br><span class="line">pip3.10 install setuptools</span><br><span class="line">pip3.10 install --target=&quot;./.python_packages/lib/site-packages&quot; -r ./requirements.txt</span><br></pre></td></tr></table></figure>

<p>查閱了 Azure 和 GitLab 的官方文檔以及技術社群中的討論，找到了有效的解決方案。<br>通過修改 template，成功解決了部署問題，<br>GitLab 和 Azure DevOps Pipeline 的整合成功。</p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Azure/azure-functions-python-worker/issues/708#issuecomment-765528255">ModuleNotFoundError when using DevOps Pipeline Task AzureFunctionApp@1</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/08/13/2024/azure_function_python_deploy_with_devops_pipeline/" data-id="cmet8nfc200f62so1anhpgfrn" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/08/13/2024/azure_function_python_deploy_with_devops_pipeline/#disqus_thread" class="article-comment-link">留言</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2024/azure_function_toggle_virtual_machine" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/08/12/2024/azure_function_toggle_virtual_machine/" class="article-date">
  <time datetime="2024-08-12T06:09:10.000Z" itemprop="datePublished">2024-08-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/08/12/2024/azure_function_toggle_virtual_machine/"> [踩雷筆記] Azure Function 開關虛擬機與錯誤排除</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>在 Azure Functions 和 Queue 的架構下，我們試圖通過自動化開關虛擬機器來節省成本。　　<br>這是因為 GPU 設備的價格相當高昂，而我們的 AI 服務又離不開這些昂貴的機器。</p>
<h2 id="實作記錄"><a href="#實作記錄" class="headerlink" title="實作記錄"></a>實作記錄</h2><p>最初的構想非常簡單：通過 Queue 接收特定的任務，然後由 Azure Function 判斷需要哪些資源，<br>如果需要進行 AI 計算，就必須啟動特定的虛擬機器，而在任務完成後，再將機器關閉。<br>這樣的方式不僅能夠節省資源，還能有效控制成本。</p>
<p>以下是 Python 程式碼的大致實作，主要為虛擬機器的開關控制邏輯：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> azure.functions <span class="keyword">as</span> func</span><br><span class="line"><span class="keyword">from</span> azure.identity <span class="keyword">import</span> DefaultAzureCredential</span><br><span class="line"><span class="keyword">from</span> azure.mgmt.compute <span class="keyword">import</span> ComputeManagementClient</span><br><span class="line"><span class="keyword">import</span> logging, os</span><br><span class="line"></span><br><span class="line">app = func.FunctionApp()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.queue_trigger(<span class="params">arg_name=<span class="string">&quot;args&quot;</span>, queue_name=<span class="string">&quot;vm-queue&quot;</span>, connection=<span class="string">&quot;CONNECTION_STRING&quot;</span></span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">args: func.QueueMessage</span>):</span><br><span class="line">    logging.info(<span class="string">&#x27;Queue Msg: %s&#x27;</span>, args.get_body().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        credential = DefaultAzureCredential()</span><br><span class="line">        subscription_id = os.getenv(<span class="string">&quot;SUBSCRIPTION&quot;</span>)</span><br><span class="line">        resource_group = os.getenv(<span class="string">&quot;RG&quot;</span>)</span><br><span class="line">        vm_name = os.getenv(<span class="string">&quot;VM_NAME&quot;</span>)</span><br><span class="line"></span><br><span class="line">        compute_client = ComputeManagementClient(credential, subscription_id)</span><br><span class="line">        vm = compute_client.virtual_machines.get(resource_group, vm_name, expand=<span class="string">&#x27;instanceView&#x27;</span>)</span><br><span class="line">        vm_status = vm.instance_view.statuses[<span class="number">1</span>].display_status</span><br><span class="line">        logging.info(<span class="string">&#x27;VM 狀態: %s&#x27;</span>, vm_status)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> vm_status == <span class="string">&quot;VM running&quot;</span>:</span><br><span class="line">            logging.info(<span class="string">&#x27;正在關閉VM: %s&#x27;</span>, vm_name)</span><br><span class="line">            operation = compute_client.virtual_machines.begin_deallocate(resource_group, vm_name)</span><br><span class="line">            operation.result()</span><br><span class="line">            logging.info(<span class="string">&#x27;%s 已關閉&#x27;</span>, vm_name)</span><br><span class="line">        <span class="keyword">elif</span> vm_status <span class="keyword">in</span> [<span class="string">&quot;VM deallocated&quot;</span>, <span class="string">&quot;VM stopped&quot;</span>]:</span><br><span class="line">            logging.info(<span class="string">&#x27;正在啟動VM: %s&#x27;</span>, vm_name)</span><br><span class="line">            operation = compute_client.virtual_machines.begin_start(resource_group, vm_name)</span><br><span class="line">            operation.result()</span><br><span class="line">            logging.info(<span class="string">&#x27;VM %s 已啟動&#x27;</span>, vm_name)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.info(<span class="string">&#x27;非預期的 VM 狀態: %s&#x27;</span>, vm_status)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">&#x27;異常錯誤: %s&#x27;</span>, <span class="built_in">str</span>(e))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="異常問題-EnvironmentCredential"><a href="#異常問題-EnvironmentCredential" class="headerlink" title="異常問題:EnvironmentCredential"></a>異常問題:EnvironmentCredential</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DefaultAzureCredential failed to retrieve a token from the included credentials.</span><br><span class="line">Attempted credentials:</span><br><span class="line"> EnvironmentCredential: EnvironmentCredential authentication unavailable. Environment variables are not fully configured.</span><br><span class="line">Visit https://aka.ms/azsdk/python/identity/environmentcredential/troubleshoot to troubleshoot this issue.</span><br><span class="line"> ManagedIdentityCredential: ManagedIdentityCredential authentication unavailable, no response from the IMDS endpoint.</span><br><span class="line"> SharedTokenCacheCredential: SharedTokenCacheCredential authentication unavailable. No accounts were found in the cache.</span><br><span class="line"> AzureCliCredential: Azure CLI not found on path</span><br><span class="line"> AzurePowerShellCredential: PowerShell is not installed</span><br><span class="line"> AzureDeveloperCliCredential: Azure Developer CLI could not be found. Please visit https://aka.ms/azure-dev for installation instructions and then,once installed, authenticate to your Azure account using &#x27;azd auth login&#x27;.</span><br><span class="line">To mitigate this issue, please refer to the troubleshooting guidelines here at https://aka.ms/azsdk/python/identity/defaultazurecredential/troubleshoot.</span><br></pre></td></tr></table></figure>

<p><strong>這個問題表面上看似由於權限不足引起的，但實際上根本原因是缺乏正確的環境變數配置。</strong><br>要使 Azure Function 能夠正常運作並獲得所需的權限，我們需要在 Function 的環境設置中正確配置相應的環境變數。<br>這些環境變數包括關鍵的憑證和授權信息，它們使得 Azure Function 能夠在執行過程中獲取必要的存取權限，從而能夠正常與 Azure 資源進行交互。<br>如果環境變數配置不當或缺失，Azure Function 將無法獲得所需的授權，從而導致權限不足的錯誤。<br>確保這些環境變數被正確設置和管理，是解決此類問題的關鍵步驟</p>
<p>配置的方式有三種</p>
<h4 id="如果要使用-Service-Principal-的-Client-Secret，配置"><a href="#如果要使用-Service-Principal-的-Client-Secret，配置" class="headerlink" title="如果要使用 Service Principal 的 Client Secret，配置"></a>如果要使用 Service Principal 的 Client Secret，配置</h4><ul>
<li>AZURE_CLIENT_ID</li>
<li>AZURE_TENANT_ID</li>
<li>AZURE_CLIENT_SECRET</li>
</ul>
<h4 id="如果要使用-Service-Principal-的-Certificate-驗證，配置"><a href="#如果要使用-Service-Principal-的-Certificate-驗證，配置" class="headerlink" title="如果要使用 Service Principal 的　Certificate 驗證，配置"></a>如果要使用 Service Principal 的　Certificate 驗證，配置</h4><ul>
<li>AZURE_CLIENT_ID</li>
<li>AZURE_TENANT_ID</li>
<li>AZURE_CLIENT_CERTIFICATE_PATH</li>
<li>AZURE_CLIENT_CERTIFICATE_PASSWORD (Optional)</li>
</ul>
<h4 id="若要使用密碼進行用戶身份驗證，配置"><a href="#若要使用密碼進行用戶身份驗證，配置" class="headerlink" title="若要使用密碼進行用戶身份驗證，配置"></a>若要使用密碼進行用戶身份驗證，配置</h4><ul>
<li>AZURE_USERNAME</li>
<li>AZURE_PASSWORD</li>
</ul>
<p>我選擇第一種配置，需要先加上 App registrations<br>具體流程如下：</p>
<ul>
<li>在 Azure Portal 上建立一個新的 Azure Registration。  </li>
<li>選擇 Certificates &amp; secrets，建立一組 Certificates &amp; secrets。  </li>
<li>到 Azure Function　Apps 設定環境變數 AZURE_CLIENT_ID 與　AZURE_CLIENT_SECRET,  </li>
<li>Tenant_ID 可以在透過 Azure Portal 找 Tenant Properties 查詢，一樣設定到環境變數。  </li>
<li>接下來將 Registration 設定為 Virtual Machine 的 Contributor<br>(待確認開關機是不是有更小的權限？ex:Virtual Machine Contributor、Virtual Machine Operator：)</li>
</ul>
<p>如此一來在開關機時就能有足夠的權限。</p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://aka.ms/azsdk/python/identity/environmentcredential/troubleshoot">https://aka.ms/azsdk/python/identity/environmentcredential/troubleshoot</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Azure/azure-sdk-for-python/blob/main/sdk/identity/azure-identity/TROUBLESHOOTING.md#troubleshoot-environmentcredential-authentication-issues">https://github.com/Azure/azure-sdk-for-python/blob/main/sdk/identity/azure-identity/TROUBLESHOOTING.md#troubleshoot-environmentcredential-authentication-issues</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-overview?pivots=programming-language-csharp">https://learn.microsoft.com/en-us/azure/azure-functions/functions-overview?pivots=programming-language-csharp</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/08/12/2024/azure_function_toggle_virtual_machine/" data-id="cmet8nfc200f92so16yh94gfs" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/08/12/2024/azure_function_toggle_virtual_machine/#disqus_thread" class="article-comment-link">留言</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2024/mysql_partial_index_and_soft_delete" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/08/05/2024/mysql_partial_index_and_soft_delete/" class="article-date">
  <time datetime="2024-08-05T05:53:10.000Z" itemprop="datePublished">2024-08-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/08/05/2024/mysql_partial_index_and_soft_delete/"> [學習筆記] SQL 軟刪除與索引 (MySQL/MSSQL/PostgreSQL)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>最近需要實現軟刪除功能，但在設計索引時遇到了一些問題。<br>商務情境如下，<br>有效的 ACCOUNT 必須是唯一的。<br>然而，帳戶有可能會被軟刪除，所以被刪除的 Account 可能會有多筆相同的資料。  </p>
<h3 id="表格設計"><a href="#表格設計" class="headerlink" title="表格設計"></a>表格設計</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">User</span> (</span><br><span class="line">    Id SERIAL <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    Username <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    IsDeleted <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">TRUE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>簡化設計的用戶表格包含 Id、Username 和 IsDeleted 欄位。<br>依商業需求，當 IsDeleted 為 0 時，Username 必須唯一。<br>而且很有可能會有多筆相同的帳號被刪除，當 IsDeleted 為 1 時，Account 不會限制只有一筆（允許多筆）</p>
<p>後端工程師建議使用觸發器（Trigger）或在應用層（Backend）實現這個約束，<br>根據我的記憶，在微軟的 SQL Server 中，有一種稱為「條件約束」的設定，能夠針對特定條件創建索引。<br>可以大幅節省開發成本，我認為這類的功能不應該只有微軟專有，故作了一些搜尋後，特別以此篇記錄。</p>
<h2 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h2><p>我找到一個測試的<a target="_blank" rel="noopener" href="https://sqlfiddle.com/">網站</a>，你可以直接在這裡測試，不需要花費額外心力建立 SQL Server</p>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 創建表格</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Users (</span><br><span class="line">    Id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    Username <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    IsDeleted <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 設置 AUTO_INCREMENT 起始值為 1000</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> Users AUTO_INCREMENT <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 創建唯一索引，只針對 IsDeleted = FALSE 的行</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX unique_active_account <span class="keyword">ON</span> Users ((<span class="keyword">CASE</span> <span class="keyword">WHEN</span> IsDeleted <span class="keyword">THEN</span> Username <span class="keyword">END</span>));</span><br><span class="line"><span class="comment">-- 插入數據</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="literal">FALSE</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user2&#x27;</span>, <span class="literal">FALSE</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user3&#x27;</span>, <span class="literal">TRUE</span>);   <span class="comment">-- 成功，因為 IsDeleted = TRUE 不受唯一索引限制</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user4&#x27;</span>, <span class="literal">FALSE</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user5&#x27;</span>, <span class="literal">TRUE</span>);   <span class="comment">-- 成功，因為 IsDeleted = TRUE 不受唯一索引限制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 測試重複的 Username 插入，應該失敗</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="literal">FALSE</span>);  <span class="comment">-- 失敗，因為 user1 已經存在且 IsDeleted = FALSE</span></span><br><span class="line"><span class="comment">-- 測試重複的 Username 插入，但 IsDeleted = TRUE，應該成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="literal">TRUE</span>);   <span class="comment">-- 成功，因為 IsDeleted = TRUE 不受唯一索引限制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 檢查插入結果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Users;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 創建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Users (</span><br><span class="line">    Id SERIAL <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    Username <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    IsDeleted <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> SEQUENCE users_id_seq RESTART <span class="keyword">WITH</span> <span class="number">1000</span>;</span><br><span class="line"><span class="comment">-- 創建部分索引，只針對 IsDeleted = FALSE 的行</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX unique_active_username <span class="keyword">ON</span> Users (Username)</span><br><span class="line"><span class="keyword">WHERE</span> IsDeleted <span class="operator">=</span> <span class="literal">FALSE</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入範例數據</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="literal">FALSE</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user2&#x27;</span>, <span class="literal">FALSE</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user3&#x27;</span>, <span class="literal">TRUE</span>);   <span class="comment">-- 成功，因為 IsDeleted = TRUE 不受唯一索引限制</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user4&#x27;</span>, <span class="literal">FALSE</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user5&#x27;</span>, <span class="literal">TRUE</span>);   <span class="comment">-- 成功，因為 IsDeleted = TRUE 不受唯一索引限制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 測試重複的 Username 插入，應該失敗</span></span><br><span class="line"><span class="comment">-- INSERT INTO Users (Username, IsDeleted) VALUES (&#x27;user1&#x27;, FALSE);  -- 失敗，因為 user1 已經存在且 IsDeleted = FALSE</span></span><br><span class="line"><span class="comment">-- 測試重複的 Username 插入，但 IsDeleted = TRUE，應該成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> Users (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="literal">TRUE</span>);   <span class="comment">-- 成功，因為 IsDeleted = TRUE 不受唯一索引限制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 檢查插入結果</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Users;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="MSSQL"><a href="#MSSQL" class="headerlink" title="MSSQL"></a>MSSQL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 設置正確的 SET 選項</span></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span>;</span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 創建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [<span class="keyword">User</span>] (</span><br><span class="line">    Id <span class="type">INT</span> <span class="keyword">IDENTITY</span>(<span class="number">1000</span>, <span class="number">1</span>) <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    Username <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    IsDeleted BIT <span class="keyword">DEFAULT</span> <span class="number">0</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 創建篩選唯一索引</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX unique_active_account <span class="keyword">ON</span> [<span class="keyword">User</span>](Username)</span><br><span class="line"><span class="keyword">WHERE</span> IsDeleted <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入範例數據</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [<span class="keyword">User</span>] (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="number">0</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [<span class="keyword">User</span>] (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user2&#x27;</span>, <span class="number">0</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [<span class="keyword">User</span>] (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user3&#x27;</span>, <span class="number">1</span>);  <span class="comment">-- 成功，因為 IsDeleted = 1 不受唯一索引限制</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [<span class="keyword">User</span>] (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user4&#x27;</span>, <span class="number">0</span>);  <span class="comment">-- 成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [<span class="keyword">User</span>] (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user5&#x27;</span>, <span class="number">1</span>);  <span class="comment">-- 成功，因為 IsDeleted = 1 不受唯一索引限制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 測試重複的 Username 插入，應該失敗</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [<span class="keyword">User</span>] (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="number">0</span>);  <span class="comment">-- 失敗，因為 user1 已經存在且 IsDeleted = 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 測試重複的 Username 插入，但 IsDeleted = 1，應該成功</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [<span class="keyword">User</span>] (Username, IsDeleted) <span class="keyword">VALUES</span> (<span class="string">&#x27;user1&#x27;</span>, <span class="number">1</span>);  <span class="comment">-- 成功，因為 IsDeleted = 1 不受唯一索引限制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 檢查插入結果</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> [<span class="keyword">User</span>];</span><br></pre></td></tr></table></figure>

<h2 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h2><p>不太需要複雜的後端程式或是 DB Trigger，只需要在建立索引時加上條件，<br>特別注意 MySQL 的語法是使用 CASE WHEN，其他 DB 是使用 WHERE，<br>這與 DB 版本也有關係，使用前應該進一步去查詢官方文件。</p>
<p>另外關於遞增欄位，在不同的 DB 也有不同的實作方式。<br>實務上通常不用了解這麼多 DB 的差異，僅僅是我個人的好奇補充罷了,<br>業界主推還是 PostgreSQL，我個人不夠專業，但三種都略有碰過，最熟的還是 MSSQL。<br>僅為個人學習記錄，如果要在三者中擇一還是需要多方考慮自身的 Context 再作決定。</p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/sql/relational-databases/tables/unique-constraints-and-check-constraints?view=sql-server-ver16">MSSQL 唯一條件約束及檢查條件約束</a></li>
<li><a target="_blank" rel="noopener" href="https://sqlfiddle.com/">SQL Fiddle</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/08/05/2024/mysql_partial_index_and_soft_delete/" data-id="cmet8nfcc00gi2so160xifsc4" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/08/05/2024/mysql_partial_index_and_soft_delete/#disqus_thread" class="article-comment-link">留言</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2024/bash_color" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/08/01/2024/bash_color/" class="article-date">
  <time datetime="2024-08-01T02:25:21.000Z" itemprop="datePublished">2024-08-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/08/01/2024/bash_color/"> [實作筆記] Bash 輸出彩色技巧</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>在 Bash 腳本中，有時我需要以提高日誌的可讀性或突顯重要資訊。<br>通過 ANSI escape codes 改變文本的顏色、背景顏色和樣式。<br>可以讓腳本的輸出更加直觀且友善。</p>
<h2 id="本文"><a href="#本文" class="headerlink" title="本文"></a>本文</h2><p>在 Bash 中，我們可以使用 ANSI escape codes 來實現文本的高亮顯示和顏色選擇。<br>以下是一些常見的 ANSI 顏色碼：</p>
<h3 id="前景顏色"><a href="#前景顏色" class="headerlink" title="前景顏色"></a>前景顏色</h3><ul>
<li><strong>黑色</strong>： <code>\033[30m</code></li>
<li><strong>紅色</strong>： <code>\033[31m</code></li>
<li><strong>綠色</strong>： <code>\033[32m</code></li>
<li><strong>黃色</strong>： <code>\033[33m</code></li>
<li><strong>藍色</strong>： <code>\033[34m</code></li>
<li><strong>洋紅色</strong>： <code>\033[35m</code></li>
<li><strong>青色</strong>： <code>\033[36m</code></li>
<li><strong>白色</strong>： <code>\033[37m</code></li>
</ul>
<h3 id="背景顏色"><a href="#背景顏色" class="headerlink" title="背景顏色"></a>背景顏色</h3><ul>
<li><strong>黑色</strong>： <code>\033[40m</code></li>
<li><strong>紅色</strong>： <code>\033[41m</code></li>
<li><strong>綠色</strong>： <code>\033[42m</code></li>
<li><strong>黃色</strong>： <code>\033[43m</code></li>
<li><strong>藍色</strong>： <code>\033[44m</code></li>
<li><strong>洋紅色</strong>： <code>\033[45m</code></li>
<li><strong>青色</strong>： <code>\033[46m</code></li>
<li><strong>白色</strong>： <code>\033[47m</code></li>
</ul>
<h3 id="樣式"><a href="#樣式" class="headerlink" title="樣式"></a>樣式</h3><ul>
<li><strong>粗體</strong>： <code>\033[1m</code></li>
<li><strong>下劃線</strong>： <code>\033[4m</code></li>
<li><strong>反向</strong>： <code>\033[7m</code></li>
<li><strong>重置</strong>： <code>\033[0m</code></li>
</ul>
<p>透過這些代碼，你可以靈活地控制文本的外觀。例如，使用 <code>\033[1;31m</code> 可以讓文本變為紅色粗體，使用 <code>\033[0m</code> 可以重置樣式回到預設。</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>下面是如何使用這些顏色碼來高亮顯示 <code>echo</code> 輸出的示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[1;31m這是一段紅色粗體文本\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[1;32m這是一段綠色粗體文本\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[1;33m這是一段黃色粗體文本\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[1;34m這是一段藍色粗體文本\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[1;35m這是一段洋紅色粗體文本\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[1;36m這是一段青色粗體文本\033[0m&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\033[1;37m這是一段白色粗體文本\033[0m&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ANSI_escape_code">ANSI escape codes - Wikipedia</a></p>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/08/01/2024/bash_color/" data-id="cmet8nfc400fj2so1g7k00mbb" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/08/01/2024/bash_color/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2024/azure_virtual_machine_for_nvidia_error_records" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/07/30/2024/azure_virtual_machine_for_nvidia_error_records/" class="article-date">
  <time datetime="2024-07-30T09:10:59.000Z" itemprop="datePublished">2024-07-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/07/30/2024/azure_virtual_machine_for_nvidia_error_records/"> [實作筆記] 初體驗設定 Nvidia GPU 的 Azure VM -- 錯誤排除</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>RD 們反應因為 Driver 更新導致服務異常，停止運作。<br>重新安裝時又遇到一些奇怪的問題，例如：<br>錯誤：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y linux-modules-nvidia-550-azure nvidia-driver-550</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">E: Unable to locate package linux-modules-nvidia-550-azure</span><br></pre></td></tr></table></figure>

<p>或是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Failed to initialize NVML: Driver/library version mismatch</span><br><span class="line">NVML library version: 535.183</span><br></pre></td></tr></table></figure>

<p>依實際狀況與 RD 討論，發現他們沒有一個標準的作業程序，調研時也沒有任何記錄，<br>東作一塊，西作一塊，沒有辦法很清楚了交互的作用關係。<br>故由我重新實作一遍，記錄並排除相關錯誤。  </p>
<h2 id="實作記錄"><a href="#實作記錄" class="headerlink" title="實作記錄"></a>實作記錄</h2><ol>
<li><p>Azure 開機，指定作業系統為 Ubuntu 22.04，並且需注意 A100 系列機器只在特定的 Zone 才有資源開機，本次使用東日本 zone2 的資源</p>
</li>
<li><p>安裝 CUDA,　<a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#ubuntu">參考官方文件 <strong>3.9. Ubuntu</strong></a></p>
</li>
<li><p>安裝 ubuntu-drivers-common</p>
<ul>
<li><code>sudo apt install ubuntu-drivers-common</code></li>
<li><code>sudo apt install alsa-utils</code> #音效相關，不一定要裝，但是可以減少指令時的錯誤訊息</li>
<li><code>ubuntu-drivers device</code></li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ubuntu-drivers devices</span><br><span class="line">== /sys/devices/LNXSYSTM:00/LNXSYBUS:00/ACPI0004:00/VMBUS:00/00000041-0001-0000-3130-444532304235/pci0001:00/0001:00:00.0 ==</span><br><span class="line">modalias : pci:v000010DEd000020B5sv000010DEsd00001533bc03sc02i00</span><br><span class="line">vendor   : NVIDIA Corporation</span><br><span class="line">driver   : nvidia-driver-555-open - third-party non-free</span><br><span class="line">driver   : nvidia-driver-470-server - distro non-free</span><br><span class="line">driver   : nvidia-driver-535-server-open - distro non-free</span><br><span class="line">driver   : nvidia-driver-555 - third-party non-free recommended</span><br><span class="line">driver   : nvidia-driver-535-server - distro non-free</span><br><span class="line">driver   : nvidia-driver-470 - distro non-free</span><br><span class="line">driver   : nvidia-driver-550 - third-party non-free</span><br><span class="line">driver   : nvidia-driver-550-open - third-party non-free</span><br><span class="line">driver   : nvidia-driver-535-open - distro non-free</span><br><span class="line">driver   : nvidia-driver-545-open - third-party non-free</span><br><span class="line">driver   : xserver-xorg-video-nouveau - distro free <span class="built_in">builtin</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>更新套件</p>
<ol>
<li>加上drivers的 repo 路徑<blockquote>
<p><code>sudo add-apt-repository ppa:graphics-drivers/ppa</code></p>
</blockquote>
</li>
<li>更新<blockquote>
<p><code>sudo apt update</code></p>
</blockquote>
</li>
<li>安裝趨動, 讓系統自已判斷安裝什麼版本, 參考 <a target="_blank" rel="noopener" href="https://ubuntu.com/server/docs/nvidia-drivers-installation">NVIDIA drivers installation | Ubuntu</a><blockquote>
<p><code>sudo ubuntu-drivers install</code></p>
</blockquote>
</li>
<li>重開機<blockquote>
<p><code>sudo reboot</code></p>
</blockquote>
</li>
<li>查一下，他幫你裝哪個版本<blockquote>
<p><code>dpkg -l | grep nvidia-driver</code></p>
</blockquote>
</li>
<li>再安裝指定版本的 Ubuntu Azure Package，也可以至 <a target="_blank" rel="noopener" href="https://packages.ubuntu.com/focal/kernel/">Ubuntu 網站</a> 搜尋確認<blockquote>
<p><code>sudo apt install -y linux-modules-nvidia-&lt;version&gt;-azure</code></p>
</blockquote>
</li>
</ol>
</li>
</ol>
<h3 id="確認是否成功"><a href="#確認是否成功" class="headerlink" title="確認是否成功"></a>確認是否成功</h3>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure>

<p>　看到下面的畫面就是成功</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ nvidia-smi</span><br><span class="line">Tue Jul 30 08:07:18 2024</span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 550.90.07              Driver Version: 550.90.07      CUDA Version: 12.4     |</span><br><span class="line">|-----------------------------------------+------------------------+----------------------+</span><br><span class="line">| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                                         |                        |               MIG M. |</span><br><span class="line">|=========================================+========================+======================|</span><br><span class="line">|   0  NVIDIA A100 80GB PCIe          Off |   00000001:00:00.0 Off |                    0 |</span><br><span class="line">| N/A   32C    P0             43W /  300W |       1MiB /  81920MiB |      0%      Default |</span><br><span class="line">|                                         |                        |             Disabled |</span><br><span class="line">+-----------------------------------------+------------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                              |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |</span><br><span class="line">|        ID   ID                                                               Usage      |</span><br><span class="line">|=========================================================================================|</span><br><span class="line">|  No running processes found                                                             |</span><br><span class="line">+-----------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://packages.ubuntu.com/focal/kernel/">Ubuntu 網站</a></li>
<li><a target="_blank" rel="noopener" href="https://ubuntu.com/server/docs/nvidia-drivers-installation">NVIDIA drivers installation | Ubuntu</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#ubuntu">參考官方文件 <strong>3.9. Ubuntu</strong></a></li>
<li><a href="https://blog.marsen.me/2024/07/03/2024/azure_vm_for_nvidia/">前篇Blog</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/07/30/2024/azure_virtual_machine_for_nvidia_error_records/" data-id="cmet8nfc400fg2so1gjdmdtd1" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/07/30/2024/azure_virtual_machine_for_nvidia_error_records/#disqus_thread" class="article-comment-link">留言</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2024/azure_virtual_machine_for_nvidia" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/07/03/2024/azure_virtual_machine_for_nvidia/" class="article-date">
  <time datetime="2024-07-03T07:59:02.000Z" itemprop="datePublished">2024-07-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/07/03/2024/azure_virtual_machine_for_nvidia/"> [實作筆記] 初體驗設定 Nvidia GPU 的 Azure VM</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>隨著深度學習和 AI 的普及，許多工作和研究需要強大的運算能力，<br>而 GPU 提供了相較於傳統 CPU 更高效的計算能力。<br>因此，我選擇在 Azure 上設定 Nvidia GPU 虛擬機來滿足這些需求。<br>這篇文章將分享我在 Azure 上設定 Nvidia GPU 虛擬機的初體驗，並記錄實作過程中的一些重點。</p>
<h2 id="前置作業"><a href="#前置作業" class="headerlink" title="前置作業"></a>前置作業</h2><p>在開始設定 GPU 虛擬機之前，需要先完成以下準備工作：</p>
<ol>
<li><strong>Azure 帳戶</strong>：確保你已經擁有 Azure 的帳戶，並且帳戶中有足夠的配額來創建 GPU 虛擬機。</li>
<li><strong>選擇適合的虛擬機規格</strong>：Azure 提供多種 GPU 虛擬機型號，如 NV 系列和 NC 系列，根據需求選擇合適的型號。</li>
<li><strong>安裝 Azure CLI</strong>：透過 Azure CLI 可以更方便地管理和配置虛擬機，可以在本地環境中安裝並配置 Azure CLI。</li>
<li><strong>創建資源群組與虛擬機</strong>：</li>
</ol>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az group create --name &lt;myResourceGroup&gt; --location eastus</span><br></pre></td></tr></table></figure>

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">az vm create \</span><br><span class="line">  --resource-group myResourceGroup \</span><br><span class="line">  --name myT4VM \</span><br><span class="line">  --image UbuntuLTS \</span><br><span class="line">  --size Standard_NC6s_v3 \</span><br><span class="line">  --admin-username azureuser \</span><br><span class="line">  --generate-ssh-keys</span><br></pre></td></tr></table></figure>

<h2 id="實作步驟"><a href="#實作步驟" class="headerlink" title="實作步驟"></a>實作步驟</h2><p>可以參考<a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#local-repo-installation-for-ubuntu">官方手冊</a>)，<br>本文大量引用 3. Package Manager Installation 中 3.9 的篇幅</p>
<h3 id="登入到虛擬機後，安裝-Nvidia-驅動程式"><a href="#登入到虛擬機後，安裝-Nvidia-驅動程式" class="headerlink" title="登入到虛擬機後，安裝 Nvidia 驅動程式"></a>登入到虛擬機後，安裝 Nvidia 驅動程式</h3>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y nvidia-driver-470</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>

<h3 id="安裝當前運行的內核版本所需的-Linux-標頭文件"><a href="#安裝當前運行的內核版本所需的-Linux-標頭文件" class="headerlink" title="安裝當前運行的內核版本所需的 Linux 標頭文件"></a>安裝當前運行的內核版本所需的 Linux 標頭文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install linux-headers-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>

<h3 id="刪除過時的金鑰-實作上，跟本沒有這個金鑰，所以跳過也沒關係"><a href="#刪除過時的金鑰-實作上，跟本沒有這個金鑰，所以跳過也沒關係" class="headerlink" title="刪除過時的金鑰(實作上，跟本沒有這個金鑰，所以跳過也沒關係)"></a>刪除過時的金鑰(實作上，跟本沒有這個金鑰，所以跳過也沒關係)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-key del 7fa2af80</span><br></pre></td></tr></table></figure>

<h3 id="查詢作業系統與晶片架構"><a href="#查詢作業系統與晶片架構" class="headerlink" title="查詢作業系統與晶片架構"></a>查詢作業系統與晶片架構</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID:	Ubuntu</span><br><span class="line">Description:	Ubuntu 22.04.4 LTS</span><br><span class="line">Release:	22.04</span><br><span class="line">Codename:	jammy</span><br><span class="line">&gt; <span class="built_in">uname</span> -m</span><br><span class="line">x86_64</span><br></pre></td></tr></table></figure>

<h3 id="安裝-CUDA-Keyring"><a href="#安裝-CUDA-Keyring" class="headerlink" title="安裝 CUDA-Keyring"></a>安裝 CUDA-Keyring</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://developer.download.nvidia.com/compute/cuda/repos/<span class="variable">$distro</span>/<span class="variable">$arch</span>/cuda-keyring_1.1-1_all.deb</span><br></pre></td></tr></table></figure>

<p>參考前一步驟將 <code>$distro</code> 換成 <code>ubuntu2204</code>，<code>$arch</code> 換成 <code>x86-64</code>,<br>也可以直接到此 <a target="_blank" rel="noopener" href="https://developer.download.nvidia.com/compute/cuda/repos">https://developer.download.nvidia.com/compute/cuda/repos</a> 找到你合適的 deb 檔<br>下載:  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86-64/cuda-keyring_1.1-1_all.deb</span><br></pre></td></tr></table></figure>

<p>安裝:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i cuda-keyring_1.1-1_all.deb</span><br></pre></td></tr></table></figure>

<h3 id="安裝-CUDA-SDK"><a href="#安裝-CUDA-SDK" class="headerlink" title="安裝 CUDA SDK"></a>安裝 CUDA SDK</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install cuda-toolkit</span><br></pre></td></tr></table></figure>

<h3 id="安裝-Nvidia-GDS-驅動，提升-GPU-和存儲間的高效數據傳輸性能"><a href="#安裝-Nvidia-GDS-驅動，提升-GPU-和存儲間的高效數據傳輸性能" class="headerlink" title="安裝 Nvidia GDS 驅動，提升 GPU 和存儲間的高效數據傳輸性能"></a>安裝 Nvidia GDS 驅動，提升 GPU 和存儲間的高效數據傳輸性能</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nvidia-gds</span><br></pre></td></tr></table></figure>

<h3 id="重啟主機"><a href="#重啟主機" class="headerlink" title="重啟主機"></a>重啟主機</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>

<h3 id="確認是否安裝成功"><a href="#確認是否安裝成功" class="headerlink" title="確認是否安裝成功"></a>確認是否安裝成功</h3>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure>

<p>　看到下面的畫面就是成功</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; nvidia-smi</span><br><span class="line">Mon Jul  1 09:21:24 2024</span><br><span class="line">+---------------------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 535.183.01             Driver Version: 535.183.01   CUDA Version: 12.2     |</span><br><span class="line">|-----------------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                                         |                      |               MIG M. |</span><br><span class="line">|=========================================+======================+======================|</span><br><span class="line">|   0  Tesla T4                       Off | 00000001:00:00.0 Off |                  Off |</span><br><span class="line">| N/A   31C    P8               9W /  70W |    140MiB / 16384MiB |      0%      Default |</span><br><span class="line">|                                         |                      |                  N/A |</span><br><span class="line">+-----------------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+---------------------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                            |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |</span><br><span class="line">|        ID   ID                                                             Usage      |</span><br><span class="line">|=======================================================================================|</span><br><span class="line">|    0   N/A  N/A      1095      G   /usr/lib/xorg/Xorg                          130MiB |</span><br><span class="line">|    0   N/A  N/A      1356      G   /usr/bin/gnome-shell                          7MiB |</span><br><span class="line">+---------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<h2 id="20240730-更新"><a href="#20240730-更新" class="headerlink" title="20240730 更新"></a>20240730 更新</h2><p>追加<a href="https://blog.marsen.me/2024/07/30/2024/azure_vm_for_nvidia_error_records/">異常記錄</a></p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-machines/sizes/overview">Sizes for virtual machines in Azure</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/n-series-driver-setup">Install NVIDIA GPU drivers on N-series VMs running Linux</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#prepare-ubuntu">NVIDIA CUDA Installation Guide for Linux</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/virtual-machines/sizes/overview?tabs=breakdownseries,generalsizelist,computesizelist,memorysizelist,storagesizelist,gpu-nc-fam,fpgasizelist,hpcsizelist#gpu-accelerated">Sizes for virtual machines in Azure</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/07/03/2024/azure_virtual_machine_for_nvidia/" data-id="cmet8nfc300fb2so18e50hokv" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/07/03/2024/azure_virtual_machine_for_nvidia/#disqus_thread" class="article-comment-link">留言</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2024/azure_virtual_machine_snapshot" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/07/01/2024/azure_virtual_machine_snapshot/" class="article-date">
  <time datetime="2024-07-01T05:02:14.000Z" itemprop="datePublished">2024-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/07/01/2024/azure_virtual_machine_snapshot/"> [實作筆記] 建立 Azure VM 的快照(Snapshot)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>這次記錄實作 Azure VM 的快照(Snapshot)與還原，與 VM images 不同，<br>快照是針對磁碟的即時捕捉，而不是整個虛擬機器的範本。<br>VM images 用於創建新的虛擬機器，是在固定的狀態下保存整個 VM，<br>包括操作系統、應用程式和所有配置。  </p>
<p>相比之下，快照則僅保存特定磁碟的狀態，適合於快速還原或備份目前正在運行的 VM。<br>選擇快照主要因為它的快速性和簡便性，可以在短時間內恢復 VM 到指定狀態，<br>以我的例子來說，我因為 AI 需求建了昂貴的 Azure VM ，使用 Image 會會佔用我們的 Quotas。<br>所以 Snapshot 會是較好的還擇</p>
<h2 id="前置作業"><a href="#前置作業" class="headerlink" title="前置作業"></a>前置作業</h2><p>在開始建立快照之前，請確保以下條件已經準備妥當：</p>
<ol>
<li>已經擁有一個可操作的 Azure 帳戶並能夠登入 Azure 入口網站。</li>
<li>目標 VM 已經啟動並運行正常，且確定需要為其建立快照。</li>
<li>已經分配足夠的儲存空間來保存快照數據。</li>
</ol>
<h2 id="實作步驟"><a href="#實作步驟" class="headerlink" title="實作步驟"></a>實作步驟</h2><h3 id="建立-Snapshot"><a href="#建立-Snapshot" class="headerlink" title="建立 Snapshot"></a>建立 Snapshot</h3><ol>
<li>登入 <a target="_blank" rel="noopener" href="https://portal.azure.com/">Azure 入口網站</a> 並進入虛擬機器(Virtual Machines)頁面。</li>
<li>從虛擬機器列表中，選擇您想要建立快照的 VM。</li>
<li>在左側導航欄中，找到並點擊 “磁碟(Disks)”。</li>
<li>在磁碟頁面中，選擇想要建立快照的磁碟(通常是 OS Disk)。</li>
<li>點擊上方的 “快照(Snapshot)” 按鈕，進入快照配置頁面。</li>
<li>在快照配置頁面中，輸入快照名稱，並選擇儲存帳戶和資源群組。</li>
<li>檢查所有設定無誤後，點擊 “建立(Create)” 按鈕，開始建立快照。這個過程可能需要幾分鐘。</li>
<li>快照建立完成後，就可以在資源群組或儲存帳戶中找到該快照，並隨時使用它來還原 VM 的狀態。</li>
</ol>
<h3 id="從-Snapshot-到-OS-Disk-到-VM"><a href="#從-Snapshot-到-OS-Disk-到-VM" class="headerlink" title="從 Snapshot 到 OS Disk 到 VM"></a>從 Snapshot 到 OS Disk 到 VM</h3><ol>
<li>在 Azure 入口網站中，進入 “快照(Snapshots)” 頁面，選擇您之前建立的快照。</li>
<li>點擊快照名稱進入詳細資訊頁面，然後選擇 “建立磁碟(Create Disk)”。</li>
<li>在磁碟配置頁面中，輸入磁碟名稱，並選擇合適的儲存帳戶和資源群組。</li>
<li>檢查所有設定無誤後，點擊 “建立(Create)” 按鈕，開始將快照轉換為磁碟。</li>
<li>磁碟建立完成後，進入 “磁碟(Disks)” 頁面，選擇您剛建立的磁碟。　　</li>
<li>在磁碟詳細資訊頁面中，點擊上方的 “建立 VM(Create VM)” 按鈕。</li>
<li>在虛擬機器配置頁面中，完成其他配置，如名稱、大小、網路設定等，然後點擊 “檢閱 + 建立(Review + create)” 按鈕。　　</li>
<li>檢查所有設定無誤後，點擊 “建立(Create)” 按鈕，開始建立新的虛擬機器。　　</li>
<li>新的虛擬機器建立完成後，登入並驗證其狀態是否與快照拍攝時一致。</li>
</ol>
<p>　　</p>
<h2 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h2><p>我發現使用 Security Type 為 Trusted Launch 的 VM 所建立的 Snapshot；　　<br>與其建立的 Disk 與 VM 其 Security Type 也會是 Trusted Launch。　　<br>但是當我嚐試透過　SSH using Azure CLI 連線 VM，<br>會遇到無法連線的問題，同樣的步驟，Security Type 為 Standard 就不會有問題。　　<br>待確認原因…　　</p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/azure/virtual-machines/windows/snapshot-copy-managed-disk">Microsoft 官方文件: 建立和管理虛擬機器磁碟的快照</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/azure/azure-portal/">Azure 入口網站指南</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/azure/virtual-machines/">Azure 虛擬機器文檔</a></li>
</ol>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/07/01/2024/azure_virtual_machine_snapshot/" data-id="cmet8nfc300fe2so10wy21bof" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/07/01/2024/azure_virtual_machine_snapshot/#disqus_thread" class="article-comment-link">留言</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2024/my_tools_2024" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/06/14/2024/my_tools_2024/" class="article-date">
  <time datetime="2024-06-14T08:51:41.000Z" itemprop="datePublished">2024-06-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/06/14/2024/my_tools_2024/"> [生活筆記] 2024 常用工具整理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="輸入法"><a href="#輸入法" class="headerlink" title="輸入法"></a>輸入法</h2><ul>
<li>無蝦米 (加速打字，未來不太看好，考慮更換中…)</li>
</ul>
<h2 id="網站"><a href="#網站" class="headerlink" title="網站"></a>網站</h2><ul>
<li><a target="_blank" rel="noopener" href="https://trends.google.com/trends/">Google Trends 技術趨勢比較</a></li>
<li>JSON 相關處理工具<ul>
<li><a target="_blank" rel="noopener" href="https://jsonformatter.curiousconcept.com/">用來除錯：找到 JSON 格式不合的地方</a></li>
<li><a target="_blank" rel="noopener" href="https://jsonformatter.org/">美化、壓縮、轉換、編碼</a></li>
<li><a target="_blank" rel="noopener" href="https://json2csharp.com/">轉換成不同語言或格式</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jsonquerytool.com/">測試 JSON Query 怎麼寫</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jsondiff.com/">比較 JSON</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://www.yamllint.com/">Yaml 格式檢查器</a></li>
<li><a target="_blank" rel="noopener" href="https://sqlformat.org/">SQL Format 檢查器</a></li>
<li>假文產生器<ul>
<li><a target="_blank" rel="noopener" href="http://www.richyli.com/tool/loremipsum/">中文</a></li>
<li><a target="_blank" rel="noopener" href="https://www.lipsum.com/feed/html">英文</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://comparetext.io/">文字比較</a></li>
<li>AI　文生文<ul>
<li><a target="_blank" rel="noopener" href="https://chat.openai.com/">ChatGPT</a></li>
<li><a target="_blank" rel="noopener" href="https://claude.ai/">Claude</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bing.com/images/create">Bing Image Create</a></li>
</ul>
</li>
<li>電子白板<ul>
<li><a target="_blank" rel="noopener" href="https://miro.com/">Miro</a></li>
</ul>
</li>
<li>心智圖<ul>
<li><a target="_blank" rel="noopener" href="https://whimsical.com/">whimsical</a></li>
</ul>
</li>
</ul>
<h2 id="資訊收集-廢文發佈-社群媒體"><a href="#資訊收集-廢文發佈-社群媒體" class="headerlink" title="資訊收集&#x2F;廢文發佈&#x2F;社群媒體"></a>資訊收集&#x2F;廢文發佈&#x2F;社群媒體</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zh-tw.facebook.com/">Facebook</a></li>
<li><a target="_blank" rel="noopener" href="https://www.explainthis.io/zh-hant">Explain this</a></li>
</ul>
<h3 id="觀察名單-待汰換"><a href="#觀察名單-待汰換" class="headerlink" title="觀察名單(待汰換)"></a>觀察名單(待汰換)</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.slant.co/">Slant 工具比較</a></li>
<li>文字比較工具 - Win Merge(Window限定)</li>
<li>Evernote<ul>
<li>專案分類</li>
<li>職涯規劃</li>
<li>已完成的項目</li>
</ul>
</li>
</ul>
<h2 id="Macbook-工具"><a href="#Macbook-工具" class="headerlink" title="Macbook 工具"></a>Macbook 工具</h2><ul>
<li>Git GUI<ul>
<li>Fork</li>
</ul>
</li>
<li>KeyCastr<ul>
<li>顯示鍵盤點擊歷程</li>
</ul>
</li>
<li>跨 PC 存放檔案<ul>
<li>Dropbox</li>
</ul>
</li>
<li>截圖錄影工具<ul>
<li>QuickTime</li>
</ul>
</li>
<li>Terminal<ul>
<li>iTerm</li>
<li><a target="_blank" rel="noopener" href="https://www.warp.dev/">Warp</a></li>
</ul>
</li>
</ul>
<h2 id="筆記工具"><a href="#筆記工具" class="headerlink" title="筆記工具"></a>筆記工具</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.notion.so/">Notion</a><ul>
<li>GTD</li>
<li>周記劃</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://hackmd.io/">HackMD</a><ul>
<li>暫存的記錄</li>
<li>會議&#x2F;社群活動即時記錄</li>
<li>Blog 草稿</li>
<li>共筆</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://marsen.me/">Blog</a><ul>
<li>技術實作記錄</li>
<li>社群活動記錄</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://notebooklm.google.com/">NotebookLM</a><ul>
<li>RAG AI 整合筆記</li>
</ul>
</li>
</ul>
<h2 id="瀏覽器-外掛"><a href="#瀏覽器-外掛" class="headerlink" title="瀏覽器 &amp; 外掛"></a>瀏覽器 &amp; 外掛</h2><p>都使用 Chromium 內核相關</p>
<ul>
<li>Brave</li>
<li>Chrome</li>
<li>Edge</li>
<li>FireFox</li>
<li>Arc 觀察中</li>
</ul>
<h3 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h3><ul>
<li>tampermonkey<ul>
<li>撰寫網頁小工具</li>
</ul>
</li>
<li>One Tab<ul>
<li>快速收攏大量分頁，常用在特殊主題搜尋的暫存</li>
</ul>
</li>
<li>Trancy<ul>
<li>沉浸式翻譯與影片翻譯</li>
</ul>
</li>
<li>Bitbucket Diff Tree<ul>
<li>Bitbucket PR 差異比較</li>
</ul>
</li>
<li>JSONView<ul>
<li>當 response 為 json 時更為好讀</li>
</ul>
</li>
<li>Bitwarden<ul>
<li>密碼管理</li>
</ul>
</li>
<li>Wappalyzer<ul>
<li>分析網站使用的框架與技術</li>
</ul>
</li>
<li>cVim<ul>
<li>使用 Vim 的習慣操作網頁</li>
</ul>
</li>
</ul>
<h2 id="開發工具"><a href="#開發工具" class="headerlink" title="開發工具"></a>開發工具</h2><ul>
<li>Vim</li>
<li>VSCode</li>
<li>JetBrain 全系列</li>
<li>Docker Desktop</li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/06/14/2024/my_tools_2024/" data-id="cmet8nfcb00gf2so123ax00rr" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/06/14/2024/my_tools_2024/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E7%AD%86%E8%A8%98/" rel="tag">生活筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2024/azure_email_communication_service" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/06/07/2024/azure_email_communication_service/" class="article-date">
  <time datetime="2024-06-07T09:58:53.000Z" itemprop="datePublished">2024-06-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/06/07/2024/azure_email_communication_service/"> [實作筆記] Azure Communication Services email</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>隨著現代企業在數位轉型中的步伐加快，電子郵件仍然是最重要的溝通工具之一。<br>公司現在的寄信服務採取了一個特別的解決方案，透過 App registrations 進行郵件發送。<br>實作的細節不展開，但這樣作有幾個問題:  </p>
<ul>
<li>App registrations 首次需人工授權取得 refresh_token</li>
<li>有了 refresh_token 仍需交換到 access_token 才能寄信</li>
<li>更新 refresh_token 失敗時，就需要人工重新介入</li>
</ul>
<p>而 Microsoft Azure 提供了強大的 Email Communication Service，可以幫助企業輕鬆、有效地發送大量電子郵件。<br>優點有整合簡單、高可擴展、安全性高、可靠性強等等優點…  </p>
<p>本篇文章將記錄我如何在 Azure 中實作 Email Communication Service。</p>
<h2 id="實作步驟"><a href="#實作步驟" class="headerlink" title="實作步驟"></a>實作步驟</h2><ol>
<li><p>建立 Azure Communication Services 資源<br>  首先，登入 Azure 入口網站，然後依序進行以下步驟：<br>  點選「建立資源」按鈕，搜尋並選擇「Communication Services」。<br>  點選「建立」按鈕，填寫必要的資訊如資源名稱、訂閱和資源群組等。<br>  選擇地區並設定其餘選項後，點選「檢閱 + 建立」，檢查設定並點選「建立」。  </p>
</li>
<li><p>配置電子郵件通道<br>  在 Communication Services 資源建立完成後，需要進行電子郵件通道的配置：<br>  在資源概覽頁面中，找到並點選「Email」。<br>  點選「新增郵件域」，並按照提示設定 SMTP 資訊及其他相關設定。<br>  驗證郵件域並完成配置。<br>  <em>這裡你需要有 domain 管理者的權限，用來在 DNS Records 建立相關的記錄(CNAME、TXT)</em></p>
</li>
<li><p>生成 API 金鑰<br>  接下來，我們需要生成 API 金鑰，以便應用程式能夠通過此金鑰進行認證和發送電子郵件：<br>  在 Communication Services 資源頁面中，找到並點選「密鑰」。<br>  點選「生成&#x2F;管理密鑰」，生成新的 API 金鑰並保存。</p>
</li>
<li><p>發送電子郵件<br>  有了 API 金鑰和配置好的電子郵件通道，現在可以使用 Azure 提供的 SDK 或 REST API 發送電子郵件。<br>  以下範例展示了如何使用 Nodejs 發送郵件：</p>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">EmailClient</span>, type <span class="title class_">EmailMessage</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@azure/communication-email&#x27;</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">sendMail = <span class="keyword">async</span> (<span class="attr">req</span>: <span class="title class_">Request</span>, <span class="attr">res</span>: <span class="title class_">Response</span>): <span class="title class_">Promise</span>&lt;<span class="keyword">void</span>&gt; =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> connectionString = <span class="title function_">env</span>(<span class="string">&#x27;COMMUNICATION_SERVICES_CONNECTION_STRING&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> senderAddress = <span class="title function_">env</span>(<span class="string">&#x27;EMAIL_SENDER_ADDRESS&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">EmailClient</span>(connectionString)</span><br><span class="line">  <span class="keyword">const</span> &#123; to, subject, html &#125; = req.<span class="property">body</span></span><br><span class="line">  <span class="keyword">const</span> attachments = (req.<span class="property">files</span> != <span class="literal">null</span>)</span><br><span class="line">    ? (req.<span class="property">files</span> <span class="keyword">as</span> <span class="title class_">Express</span>.<span class="property">Multer</span>.<span class="property">File</span>[]).<span class="title function_">map</span>(<span class="function"><span class="params">file</span> =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">name</span>: file.<span class="property">originalname</span>,</span><br><span class="line">        <span class="attr">contentType</span>: file.<span class="property">mimetype</span>,</span><br><span class="line">        <span class="attr">contentInBase64</span>: file.<span class="property">buffer</span>.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">      &#125;))</span><br><span class="line">    : []</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">emailMessage</span>: <span class="title class_">EmailMessage</span> = &#123;</span><br><span class="line">    senderAddress,</span><br><span class="line">    <span class="attr">content</span>: &#123;</span><br><span class="line">      subject,</span><br><span class="line">      html</span><br><span class="line">    &#125;,</span><br><span class="line">    attachments,</span><br><span class="line">    <span class="attr">recipients</span>: &#123;</span><br><span class="line">      <span class="attr">to</span>: [&#123; <span class="attr">address</span>: to &#125;],</span><br><span class="line">      <span class="attr">bcc</span>: [&#123; <span class="attr">address</span>: <span class="string">&#x27;noreply@marsen.me&#x27;</span> &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> poller = <span class="keyword">await</span> client.<span class="title function_">beginSend</span>(emailMessage)</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> poller.<span class="title function_">pollUntilDone</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;result:&#x27;</span>, result)</span><br><span class="line">  res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">`Email <span class="subst">$&#123;subject&#125;</span> Sent!`</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在-Azure-Portal-執行整合測試"><a href="#在-Azure-Portal-執行整合測試" class="headerlink" title="在 Azure Portal 執行整合測試"></a>在 Azure Portal 執行整合測試</h3><p>在 Azure Portal &gt; Communication Service &gt; Email &gt; Try Email，<br>非常貼心的提供了 C#、JavaScript、Java、Python、cUrl　的範本，<br>也可以取得連線字串。</p>
<h3 id="使用上限與新增寄件帳號"><a href="#使用上限與新增寄件帳號" class="headerlink" title="使用上限與新增寄件帳號"></a>使用上限與新增寄件帳號</h3><p>原則上預設的使用量對開發人員來說，是非常足夠的<br>但是如果想增加上限，或是新增其它的寄件者帳號，需要開 support ticket 進行升級，<br>這是為了避免郵件的濫用，另外需新增 MX Record 可以避免當成垃圾郵件。<br>升級後就可以在 Azure Portal &gt; Email Communication Service &gt; Provision domains &gt; MailFrom addresses<br>新增寄件者，實際上 Azure Communication Service 只會寄件無法收件，<br>即使在 O365 有相同的帳號，在寄件備份中也看不到透過 ECS 寄出的郵件。　　</p>
<h2 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h2><p>實作上比較有風險大概是 DNS Records 的設定，最久大約需等到 1 小時生效。<br>而開發上非常的容易，甚至程式範例都整合到 Portal，非常方便。 　<br>但是其它方面需要開票等待 Azure 協力升級與設定，就會比較麻煩。 　</p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/communication-services/concepts/email/email-overview">Overview of Azure Communication Services email</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/communication-services/quickstarts/create-communication-resource?tabs=windows&pivots=platform-azp">Quickstart: Create and manage Communication Services resources</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/azure/communication-services/concepts/email/email-quota-increase">Quota increase for email domains</a></li>
<li><a target="_blank" rel="noopener" href="https://azure.microsoft.com/en-us/support/create-ticket/">Create Support Ticket</a></li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/06/07/2024/azure_email_communication_service/" data-id="cmet8nfc100f12so15rbv51ig" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/06/07/2024/azure_email_communication_service/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2024/gitlab_ci_and_gcs_as_static_site" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/05/14/2024/gitlab_ci_and_gcs_as_static_site/" class="article-date">
  <time datetime="2024-05-14T03:42:53.000Z" itemprop="datePublished">2024-05-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2024/05/14/2024/gitlab_ci_and_gcs_as_static_site/"> [踩雷筆記] Gitlab CI/CD 與 GCP - 靜態網站部署整合 404 與 `/`</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h2><p>最近將公司的所有靜態網站轉換到 GCS 上了，遇到一些情境，特此記錄<br>這篇會以 Vue 與 Nuxt 的角度出發。<br>在前後端分離的情況下，SEO 變成一個問題，SSR 可以解決這個問題，<br>我們可以使用 Nuxt 建立我們的專案，並透過 <code>generate</code> 生成靜態檔案。</p>
<p>再進一步來說，我們可以整合 <a target="_blank" rel="noopener" href="https://cloud.google.com/storage/docs/hosting-static-website">GCS 進行靜態網站的部署</a></p>
<h3 id="題外話"><a href="#題外話" class="headerlink" title="題外話"></a>題外話</h3><p>Nuxt 的幾種建置方式</p>
<ol>
<li><p><code>npx nuxt build</code><br>  The build command creates a .output directory with all your application, server and dependencies ready for production.<br>  這個命令會建立一個 .output 目錄，裡面包含了你的應用程式、伺服器和所有必要的依賴，準備好用於生產環境。<br>  預設的行為，可以實作 SSR(Server Side Render)，適用有 SEO 需求，且變化快速的網站，Ex: 電商產品頁</p>
</li>
<li><p><code>npx nuxt build --prerender</code><br>  –prerender	false	Pre-render every route of your application. (note: This is an experimental flag. The behavior might be changed.) .<br>  –prerender false 會對應用程式的每個路由進行預渲染。（注意：這是一個實驗性的標誌。行為可能會更改。）；<br>  它會先產生好 HTML，適合 SSG 網站(內容不常改動，但有 SEO 需求）。Ex: BLOG</p>
</li>
<li><p><code>npx nuxt generate </code></p>
</li>
</ol>
<p>  The generate command pre-renders every route of your application and stores the result in plain HTML files that you can deploy on any static hosting services. The command triggers the nuxi build command with the prerender argument set to true<br>  這個命令會對你的應用程式的每個路由進行預渲染，並將結果存儲在普通的 HTML 文件中，你可以部署到任何靜態托管服務上。　　<br>  該命令會觸發 nuxi build 命令，並將 prerender 參數設置為 true。<br>  它適合純靜態的網頁(SPA)。Ex: Landing Page.　與前者最大的差異是，前者會建置成不同的 HTML，</p>
<h2 id="問題"><a href="#問題" class="headerlink" title="問題"></a>問題</h2><p>當我們在建置好靜態網站並部署到 GCS 上時，我遇到了一個異常的問題，<br>當我複製貼上網址時會發生 404 Not Found，主因是當我的網址結尾不是<code>/</code>時，<br>瀏覽器會轉導到 <code>/index.html</code>。<br>舉例說明:</p>
<p><code>https://marsen.me/sample</code> 複製貼上，會轉導到 <code>https://marsen.me/sample/index.html</code><br>而這頁不存在，導致產生 404 的錯誤</p>
<h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><p>採取升級 Nuxt 到 <a target="_blank" rel="noopener" href="https://github.com/nuxt/nuxt/releases/tag/v3.8.0">v3.8.0</a> 以上，<br>這是實驗性的功能，雖然目前有效，仍需觀注未來更新的狀況。<br>若不打算升級，另外有用 <code>middleware</code> 處理重定向，<br>可參考此 <a target="_blank" rel="noopener" href="https://github.com/nuxt/nuxt/issues/15462#issuecomment-1407374859">issue</a> 的討論串，<br>要寫比較多，而且留言者在部署到 vercel 有遇到其他問題。故採升級的方式解決此題。</p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a href="https://blog.marsen.me/2022/03/09/2022/gcp_static_site_with_cloud_storage_and_loading_balancing/">靜態網站部署整合 GCP - Load Balancing &amp; Cloud Storage</a></li>
<li>[實作筆記] Gitlab CI&#x2F;CD 與 GCP 相關文章<ul>
<li><a href="https://blog.marsen.me/2023/04/13/2023/gitlab_ci_and_gcp_vm/">架構全貌</a></li>
<li><a href="https://blog.marsen.me/2023/04/14/2023/gitlab_ci_and_gcp_vm_create_server/">建立 Web Server VM</a></li>
<li><a href="https://blog.marsen.me/2023/04/14/2023/gitlab_ci_and_gcp_vm_cretae_runner/">建立 Gitlab Runner VM</a></li>
<li><a href="https://blog.marsen.me/2023/04/14/2023/gitlab_ci_and_gcp_vm_firewall/">防火牆設定</a></li>
<li><a href="https://blog.marsen.me/2023/04/24/2023/gitlab_ci_and_gcp_vm_account/">Linux User 與資料夾權限</a></li>
<li><a href="https://blog.marsen.me/2023/05/29/2023/gitlab_ci_and_gcp_vm_secret_config/">機敏資料的處理</a></li>
<li><a href="https://blog.marsen.me/2023/11/16/2023/gitlab_ci_error_handle/">錯誤處理</a></li>
<li><a href="https://blog.marsen.me/2024/03/13/2024/gitlab_ci_and_gcp_workload_federation/">Workload Identity Federation</a></li>
<li><a href="https://blog.marsen.me/2024/04/17/2024/gitlab_ci_and_gcp_cloud_run/">Cloud Run</a></li>
</ul>
</li>
</ul>
<p>(fin)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.marsen.me/2024/05/14/2024/gitlab_ci_and_gcs_as_static_site/" data-id="cmet8nfc900g52so1bwwo2963" class="article-share-link">Share</a>
      
        <a href="https://blog.marsen.me/2024/05/14/2024/gitlab_ci_and_gcs_as_static_site/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/4/">← 上一頁</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/6/">下一頁 →</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/08/12/2025/backend-architecture-layer-design-principles/"> [架構筆記] Clean Architecture 分層職責的反思</a>
          </li>
        
          <li>
            <a href="/2025/08/07/2025/race-condition-in-file-storage/"> [學習筆記] Node.js 檔案操作 mkdir 的正確姿勢</a>
          </li>
        
          <li>
            <a href="/2025/07/31/2025/ai_google_search_api/"> [實作筆記] AI Agent 實作 Web Search API：從設計到部署的完整記錄</a>
          </li>
        
          <li>
            <a href="/2025/07/29/2025/ai-eai-browser-install-flatpak-solution/"> [實作筆記] EAI 機器瀏覽器安裝問題與解決方案</a>
          </li>
        
          <li>
            <a href="/2025/07/25/2025/express-res-locals-auth-best-practice/"> [學習筆記] Express.js middleware auth 的業界標準(res.locals)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">彙整</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">八月 2025</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/07/">七月 2025</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">六月 2025</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">五月 2025</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">四月 2025</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">三月 2025</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/02/">二月 2025</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">一月 2025</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">十二月 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">十一月 2024</a><span class="archive-list-count">3</span></li><span id='list_archives2' style='display:none'><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">十月 2024</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">九月 2024</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">八月 2024</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">六月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">五月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">四月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">一月 2024</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">6</span></li></span><span id=''></span><span onclick="var d=document.getElementById('list_archives2'); d.style.display===''?d.style='display:none':d.style=''">toggle...</span></ul>
    </div>
  </div>


  
    <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/3.0/tw/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/3.0/tw/88x31.png" />
</a>
  <br />
This work is licensed under a 
<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/3.0/tw/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Taiwan License</a>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤雲</h3>
    <div class="widget tagcloud">
      <a href="/tags/Net-Framework/" style="font-size: 14.67px;">.Net Framework</a> <a href="/tags/API/" style="font-size: 11.33px;">API</a> <a href="/tags/AWS/" style="font-size: 13.33px;">AWS</a> <a href="/tags/Agile/" style="font-size: 17.33px;">Agile</a> <a href="/tags/CI-CD/" style="font-size: 19.33px;">CI/CD</a> <a href="/tags/Cache/" style="font-size: 10px;">Cache</a> <a href="/tags/Coding-Standard/" style="font-size: 10px;">Coding Standard</a> <a href="/tags/Container/" style="font-size: 12px;">Container</a> <a href="/tags/Database/" style="font-size: 12.67px;">Database</a> <a href="/tags/Design-Pattern/" style="font-size: 10.67px;">Design Pattern</a> <a href="/tags/Docker/" style="font-size: 12px;">Docker</a> <a href="/tags/Entity-Framework/" style="font-size: 10.67px;">Entity Framework</a> <a href="/tags/Firebase/" style="font-size: 10px;">Firebase</a> <a href="/tags/Git/" style="font-size: 10.67px;">Git</a> <a href="/tags/Golang/" style="font-size: 11.33px;">Golang</a> <a href="/tags/Google/" style="font-size: 11.33px;">Google</a> <a href="/tags/GulpJs/" style="font-size: 10.67px;">GulpJs</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hexo/" style="font-size: 15.33px;">Hexo</a> <a href="/tags/IIS/" style="font-size: 10px;">IIS</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/Integrated-Testing/" style="font-size: 10px;">Integrated Testing</a> <a href="/tags/Jenkins/" style="font-size: 12px;">Jenkins</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 10.67px;">Linux</a> <a href="/tags/Mongodb/" style="font-size: 10px;">Mongodb</a> <a href="/tags/MsSQL/" style="font-size: 11.33px;">MsSQL</a> <a href="/tags/MsTest/" style="font-size: 10px;">MsTest</a> <a href="/tags/Mutation-Testing/" style="font-size: 10px;">Mutation Testing</a> <a href="/tags/Nodejs/" style="font-size: 15.33px;">Nodejs</a> <a href="/tags/OAuth/" style="font-size: 10px;">OAuth</a> <a href="/tags/OOP/" style="font-size: 11.33px;">OOP</a> <a href="/tags/Openshift/" style="font-size: 10.67px;">Openshift</a> <a href="/tags/PowerShell/" style="font-size: 11.33px;">PowerShell</a> <a href="/tags/React/" style="font-size: 12px;">React</a> <a href="/tags/Redis/" style="font-size: 10.67px;">Redis</a> <a href="/tags/SQL/" style="font-size: 12px;">SQL</a> <a href="/tags/Scrum/" style="font-size: 16.67px;">Scrum</a> <a href="/tags/Shell/" style="font-size: 10.67px;">Shell</a> <a href="/tags/Specflow/" style="font-size: 10px;">Specflow</a> <a href="/tags/StyleCop/" style="font-size: 10px;">StyleCop</a> <a href="/tags/TDD/" style="font-size: 16px;">TDD</a> <a href="/tags/Testing/" style="font-size: 14px;">Testing</a> <a href="/tags/Thread/" style="font-size: 10.67px;">Thread</a> <a href="/tags/Trello/" style="font-size: 10px;">Trello</a> <a href="/tags/TypeScript/" style="font-size: 13.33px;">TypeScript</a> <a href="/tags/Unit-Testing/" style="font-size: 18.67px;">Unit Testing</a> <a href="/tags/Unix/" style="font-size: 10.67px;">Unix</a> <a href="/tags/Vim/" style="font-size: 10px;">Vim</a> <a href="/tags/Visual-Studio/" style="font-size: 10px;">Visual Studio</a> <a href="/tags/html/" style="font-size: 10px;">html</a> <a href="/tags/post/" style="font-size: 10px;">post</a> <a href="/tags/%E5%AD%B8%E7%BF%92%E7%AD%86%E8%A8%98/" style="font-size: 17.33px;">學習筆記</a> <a href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" style="font-size: 20px;">實作筆記</a> <a href="/tags/%E6%99%82%E9%96%93%E7%AE%A1%E7%90%86/" style="font-size: 10.67px;">時間管理</a> <a href="/tags/%E6%B4%BB%E5%8B%95%E7%AD%86%E8%A8%98/" style="font-size: 12.67px;">活動筆記</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E7%AD%86%E8%A8%98/" style="font-size: 16.67px;">生活筆記</a> <a href="/tags/%E8%A8%98%E9%8C%84/" style="font-size: 11.33px;">記錄</a> <a href="/tags/%E8%B8%A9%E9%9B%B7%E7%AD%86%E8%A8%98/" style="font-size: 16px;">踩雷筆記</a> <a href="/tags/%E9%87%8D%E6%A7%8B/" style="font-size: 12px;">重構</a> <a href="/tags/%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/" style="font-size: 18px;">閱讀筆記</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Net-Framework/" rel="tag">.Net Framework</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/API/" rel="tag">API</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWS/" rel="tag">AWS</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Agile/" rel="tag">Agile</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI-CD/" rel="tag">CI&#x2F;CD</a><span class="tag-list-count">24</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cache/" rel="tag">Cache</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Coding-Standard/" rel="tag">Coding Standard</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Container/" rel="tag">Container</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/" rel="tag">Database</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Design-Pattern/" rel="tag">Design Pattern</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Entity-Framework/" rel="tag">Entity Framework</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Firebase/" rel="tag">Firebase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Google/" rel="tag">Google</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GulpJs/" rel="tag">GulpJs</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IIS/" rel="tag">IIS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/" rel="tag">IO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Integrated-Testing/" rel="tag">Integrated Testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mongodb/" rel="tag">Mongodb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MsSQL/" rel="tag">MsSQL</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MsTest/" rel="tag">MsTest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mutation-Testing/" rel="tag">Mutation Testing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/" rel="tag">Nodejs</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OAuth/" rel="tag">OAuth</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OOP/" rel="tag">OOP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openshift/" rel="tag">Openshift</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PowerShell/" rel="tag">PowerShell</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL/" rel="tag">SQL</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scrum/" rel="tag">Scrum</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Specflow/" rel="tag">Specflow</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/StyleCop/" rel="tag">StyleCop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDD/" rel="tag">TDD</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Testing/" rel="tag">Testing</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thread/" rel="tag">Thread</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Trello/" rel="tag">Trello</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unit-Testing/" rel="tag">Unit Testing</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unix/" rel="tag">Unix</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vim/" rel="tag">Vim</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Visual-Studio/" rel="tag">Visual Studio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html/" rel="tag">html</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/post/" rel="tag">post</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%B8%E7%BF%92%E7%AD%86%E8%A8%98/" rel="tag">學習筆記</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%A6%E4%BD%9C%E7%AD%86%E8%A8%98/" rel="tag">實作筆記</a><span class="tag-list-count">126</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%99%82%E9%96%93%E7%AE%A1%E7%90%86/" rel="tag">時間管理</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B4%BB%E5%8B%95%E7%AD%86%E8%A8%98/" rel="tag">活動筆記</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E7%AD%86%E8%A8%98/" rel="tag">生活筆記</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A8%98%E9%8C%84/" rel="tag">記錄</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B8%A9%E9%9B%B7%E7%AD%86%E8%A8%98/" rel="tag">踩雷筆記</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%87%8D%E6%A7%8B/" rel="tag">重構</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%96%B1%E8%AE%80%E7%AD%86%E8%A8%98/" rel="tag">閱讀筆記</a><span class="tag-list-count">15</span></li></ul>
    </div>
  </div>


  
    

  
    <div class="widget-wrap">
    <h3 class="widget-title">多語系</h3>
    <div class="widget">
        <div id="ytWidget"></div>
    </div>
</div>
<script src="https://translate.yandex.net/website-widget/v1/widget.js?widgetId=ytWidget&pageLang=zh&widgetTheme=dark&autoMode=false" type="text/javascript"></script>
  
    <div class="widget-wrap">
    <h3 class="widget-title">BADGES</h3>
    <div class="widget">
        <a target="_blank" rel="noopener" href="https://bcert.me/bc/html/show-badge.html?b=uufxvngl">
            <img src="/images/2018/csm/seal-csm.png" alt="Certified ScrumMaster®">
        </a>
    </div>
</div>
  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2025 Marsen L.<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>



<script src="/js/sayings.js?v=0.js"></script>
  

<script src="/js/script.js?v=0.js"></script>

<div id="likecoin">
Please enable JavaScript to view the LikeCoin. :P
</div>
<script>

  (function(){
    var ifrm = document.createElement("iframe");
    ifrm.setAttribute("src", "https://button.like.co/in/embed/marsenlin/button?referrer=undefined");      
    ifrm.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox");
    ifrm.frameborder = "0";
    ifrm.scrolling = "no";
    (document.getElementById("likecoin").replaceChild(ifrm, document.getElementById("likecoin").childNodes[0]));
  })();

</script>
<script>

  var disqus_shortname = 'marsenlin';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();

</script>

  </div>
    
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NTDGNJZ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

</body>
</html>